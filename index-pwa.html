<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Aggregator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3.5.28/dist/vue.global.js" integrity="sha384-wnGtVZYd19ZTuarGUIotKU1XHhyQZyufn6NKf58XymsPoQvKDxaT2COTn9BRU6k6" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" integrity="sha384-D/t0ZMqQW31H3az8ktEiNb39wyKnS82iFY52QPACM+IjKW3jDUhyIgh2PApRqJZs" crossorigin="anonymous"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="/firebase-config.js"></script>

    <!-- PWA Configuration -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('SW registered:', reg))
                    .catch(err => console.error('SW registration failed:', err));
            });
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen overflow-x-hidden">
    <div id="app" class="container mx-auto px-4 py-8 max-w-full overflow-x-hidden">
        <header class="mb-8">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">Portfolio Aggregator</h1>
                    <p class="text-gray-600">Upload your IBKR and Trading 212 CSVs to view your complete portfolio</p>
                </div>
                <div class="flex flex-wrap items-center gap-3 text-sm">
                    <!-- Sync Status -->
                    <div class="flex items-center gap-2">
                        <div v-if="syncStatus === 'synced'" class="flex items-center gap-1 text-green-600">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>Synced</span>
                        </div>
                        <div v-else-if="syncStatus === 'syncing'" class="flex items-center gap-1 text-blue-600">
                            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                            </svg>
                            <span>Syncing...</span>
                        </div>
                        <div v-else-if="syncStatus === 'offline'" class="text-yellow-600">
                            Offline
                        </div>
                        <div v-else-if="syncStatus === 'error'" class="text-red-600 cursor-pointer" @click="syncFromCloud()" title="Click to retry">
                            âš  Error (tap to retry)
                        </div>
                    </div>

                    <!-- Account Info -->
                    <div v-if="user" class="flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-lg">
                        <span class="text-gray-700">{{ user.email }}</span>
                        <button @click="logout()" class="text-blue-600 hover:underline">
                            Logout
                        </button>
                    </div>

                    <!-- Install Button -->
                    <button
                        v-if="showInstallPrompt"
                        @click="installPWA"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                    >
                        Install App
                    </button>

                    <!-- Clear All Data button -->
                    <button
                        v-if="hasData"
                        @click="clearAllData"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
                    >
                        Clear All Data
                    </button>
                </div>
            </div>
        </header>

        <!-- Upload Section -->
        <div class="hidden md:grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Trading 212 Upload -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Trading 212</h2>
                <div
                    class="border-2 border-dashed rounded-lg p-6 text-center transition"
                    :class="t212Dragging ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-blue-500'"
                    @dragover.prevent="t212Dragging = true"
                    @dragenter.prevent="t212Dragging = true"
                    @dragleave.prevent="t212Dragging = false"
                    @drop.prevent="handleT212Drop"
                >
                    <input
                        type="file"
                        @change="handleT212Upload"
                        accept=".csv"
                        ref="t212Input"
                        class="hidden"
                        id="t212-upload"
                    >
                    <label for="t212-upload" class="cursor-pointer">
                        <svg class="mx-auto h-12 w-12 mb-3" :class="t212Dragging ? 'text-blue-500' : 'text-gray-400'" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span class="text-sm" :class="t212Dragging ? 'text-blue-600' : 'text-gray-600'">
                            {{ t212Dragging ? 'Drop file here' : 'Drag & drop or click to upload Trading 212 CSV' }}
                        </span>
                    </label>
                </div>
                <div v-if="t212Loading" class="mt-4 flex items-center justify-center bg-blue-50 p-4 rounded">
                    <svg class="animate-spin h-5 w-5 text-blue-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-sm text-blue-600">Processing file & fetching prices...</span>
                </div>
                <div v-else-if="t212File" class="mt-4 flex items-center justify-between bg-blue-50 p-3 rounded">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">{{ t212File.name }}</p>
                        <p class="text-xs text-gray-500">{{ t212RowCount }} positions loaded</p>
                    </div>
                    <button @click="clearT212" class="text-red-600 hover:text-red-800 text-sm font-medium">Clear</button>
                </div>
                <div v-if="t212Error" class="mt-4 bg-red-50 border border-red-200 rounded p-3">
                    <p class="text-sm text-red-800">{{ t212Error }}</p>
                </div>
            </div>

            <!-- IBKR Upload -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Interactive Brokers</h2>
                <div
                    class="border-2 border-dashed rounded-lg p-6 text-center transition"
                    :class="ibkrDragging ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-blue-500'"
                    @dragover.prevent="ibkrDragging = true"
                    @dragenter.prevent="ibkrDragging = true"
                    @dragleave.prevent="ibkrDragging = false"
                    @drop.prevent="handleIBKRDrop"
                >
                    <input
                        type="file"
                        @change="handleIBKRUpload"
                        accept=".csv"
                        ref="ibkrInput"
                        class="hidden"
                        id="ibkr-upload"
                    >
                    <label for="ibkr-upload" class="cursor-pointer">
                        <svg class="mx-auto h-12 w-12 mb-3" :class="ibkrDragging ? 'text-blue-500' : 'text-gray-400'" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span class="text-sm" :class="ibkrDragging ? 'text-blue-600' : 'text-gray-600'">
                            {{ ibkrDragging ? 'Drop file here' : 'Drag & drop or click to upload IBKR CSV' }}
                        </span>
                    </label>
                </div>
                <div v-if="ibkrFile" class="mt-4 flex items-center justify-between bg-blue-50 p-3 rounded">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">{{ ibkrFile.name }}</p>
                        <p class="text-xs text-gray-500">{{ ibkrRowCount }} positions loaded</p>
                    </div>
                    <button @click="clearIBKR" class="text-red-600 hover:text-red-800 text-sm font-medium">Clear</button>
                </div>
                <div v-if="ibkrError" class="mt-4 bg-red-50 border border-red-200 rounded p-3">
                    <p class="text-sm text-red-800">{{ ibkrError }}</p>
                </div>
            </div>
        </div>

        <!-- Manual Cash Entry -->
        <div class="hidden md:block bg-white rounded-lg shadow p-4 md:p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Manual Cash Balances</h2>
            <div class="space-y-4">
                <div v-for="(entry, index) in manualCashEntries" :key="index" class="border border-gray-200 rounded-lg p-3 md:p-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input
                            v-model="entry.label"
                            type="text"
                            placeholder="e.g. Barclays Current"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm md:text-base"
                        >
                        <div class="flex gap-2">
                            <input
                                v-model.number="entry.valueGBP"
                                type="number"
                                placeholder="Amount (Â£)"
                                step="0.01"
                                class="flex-1 sm:w-40 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm md:text-base"
                            >
                            <button
                                @click="removeManualCash(index)"
                                class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition text-sm md:text-base whitespace-nowrap"
                            >
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <button
                @click="addManualCash"
                class="mt-4 w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm md:text-base"
            >
                + Add Another
            </button>
        </div>

        <!-- Summary Cards -->
        <div v-if="portfolio.totalNetWorth > 0" class="hidden md:block space-y-6 mb-8">
            <!-- Total Profit Banner -->
            <div v-if="portfolio.totalInvested > 0 || portfolio.totalRealisedPL !== 0" class="bg-white rounded-lg shadow p-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 mb-1">Total Profit/Loss</h3>
                        <p class="text-3xl font-bold" :class="{
                            'text-green-600': portfolio.totalPL > 0,
                            'text-red-600': portfolio.totalPL < 0,
                            'text-gray-900': portfolio.totalPL === 0
                        }">
                            {{ portfolio.totalPL >= 0 ? '+' : '' }}Â£{{ formatNumber(Math.abs(portfolio.totalPL)) }}
                            <span class="text-lg font-medium ml-2" :class="{
                                'text-green-600': portfolio.totalPLPercent > 0,
                                'text-red-600': portfolio.totalPLPercent < 0,
                                'text-gray-500': portfolio.totalPLPercent === 0
                            }">
                                ({{ portfolio.totalPLPercent >= 0 ? '+' : '' }}{{ portfolio.totalPLPercent.toFixed(2) }}%)
                            </span>
                        </p>
                    </div>
                    <div class="flex flex-wrap gap-6 text-sm">
                        <div>
                            <span class="text-gray-500">Unrealised</span>
                            <p class="font-semibold" :class="{
                                'text-green-600': portfolio.totalUnrealisedPL > 0,
                                'text-red-600': portfolio.totalUnrealisedPL < 0,
                                'text-gray-900': portfolio.totalUnrealisedPL === 0
                            }">
                                {{ portfolio.totalUnrealisedPL >= 0 ? '+' : '' }}Â£{{ formatNumber(Math.abs(portfolio.totalUnrealisedPL)) }}
                            </p>
                        </div>
                        <div>
                            <span class="text-gray-500">Realised</span>
                            <p class="font-semibold" :class="{
                                'text-green-600': portfolio.totalRealisedPL > 0,
                                'text-red-600': portfolio.totalRealisedPL < 0,
                                'text-gray-900': portfolio.totalRealisedPL === 0
                            }">
                                {{ portfolio.totalRealisedPL >= 0 ? '+' : '' }}Â£{{ formatNumber(Math.abs(portfolio.totalRealisedPL)) }}
                            </p>
                        </div>
                        <div>
                            <span class="text-gray-500">Total Invested</span>
                            <p class="font-semibold text-gray-900">Â£{{ formatNumber(portfolio.totalInvested) }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg shadow-lg p-6 text-white md:col-span-1">
                    <h3 class="text-sm font-medium text-blue-100 mb-2">Total Net Worth</h3>
                    <p class="text-4xl font-bold">Â£{{ formatNumber(portfolio.totalNetWorth) }}</p>
                </div>

                <div class="bg-white rounded-lg shadow p-6 md:col-span-2">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Asset Allocation</h3>
                    <div class="flex items-center gap-6">
                        <!-- Pie Chart -->
                        <div class="flex-shrink-0">
                            <div class="w-32 h-32 rounded-full" :style="{
                                background: getAssetAllocationGradient()
                            }"></div>
                        </div>
                        <!-- Legend -->
                        <div class="flex-1 space-y-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 bg-green-500 rounded"></div>
                                    <span class="text-sm font-medium text-gray-700">Cash</span>
                                </div>
                                <span class="text-sm font-semibold text-gray-900">Â£{{ formatNumber(portfolio.cashTotal) }} ({{ portfolio.cashPercentage.toFixed(1) }}%)</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 bg-purple-500 rounded"></div>
                                    <span class="text-sm font-medium text-gray-700">VUSA</span>
                                </div>
                                <span class="text-sm font-semibold text-gray-900">Â£{{ formatNumber(portfolio.vusaTotal) }} ({{ portfolio.vusaPercentage.toFixed(1) }}%)</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 bg-blue-500 rounded"></div>
                                    <span class="text-sm font-medium text-gray-700">Other Stocks</span>
                                </div>
                                <span class="text-sm font-semibold text-gray-900">Â£{{ formatNumber(portfolio.otherStocksTotal) }} ({{ portfolio.otherStocksPercentage.toFixed(1) }}%)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Broker Breakdown -->
            <div class="hidden md:block bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">By Broker</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Trading 212 -->
                    <div v-if="portfolio.t212Total > 0" class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-gray-900">Trading 212</h4>
                            <span class="text-lg font-bold text-purple-600">Â£{{ formatNumber(portfolio.t212Total) }}</span>
                        </div>
                        <div class="text-xs space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Cash</span>
                                <span class="font-semibold">Â£{{ formatNumber(portfolio.t212Cash) }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Stocks</span>
                                <span class="font-semibold">Â£{{ formatNumber(portfolio.t212Stocks) }}</span>
                            </div>
                            <div v-if="portfolio.t212Invested > 0" class="pt-2 mt-2 border-t border-gray-200">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-gray-600">Invested</span>
                                    <span class="font-semibold">Â£{{ formatNumber(portfolio.t212Invested) }}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Unrealised P/L</span>
                                    <span class="font-semibold" :class="{
                                        'text-green-600': portfolio.t212PL > 0,
                                        'text-red-600': portfolio.t212PL < 0
                                    }">
                                        {{ portfolio.t212PL >= 0 ? '+' : '' }}Â£{{ formatNumber(portfolio.t212PL) }}
                                        ({{ portfolio.t212PL >= 0 ? '+' : '' }}{{ portfolio.t212PLPercent.toFixed(2) }}%)
                                    </span>
                                </div>
                            </div>
                            <div v-if="portfolio.t212RealisedPL !== 0" class="pt-2 mt-2 border-t border-gray-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Realised P/L</span>
                                    <span class="font-semibold" :class="{
                                        'text-green-600': portfolio.t212RealisedPL > 0,
                                        'text-red-600': portfolio.t212RealisedPL < 0
                                    }">
                                        {{ portfolio.t212RealisedPL >= 0 ? '+' : '' }}Â£{{ formatNumber(Math.abs(portfolio.t212RealisedPL)) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Interactive Brokers -->
                    <div v-if="portfolio.ibkrTotal > 0" class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-gray-900">Interactive Brokers</h4>
                            <span class="text-lg font-bold text-blue-600">Â£{{ formatNumber(portfolio.ibkrTotal) }}</span>
                        </div>
                        <div class="text-xs space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Cash</span>
                                <span class="font-semibold">Â£{{ formatNumber(portfolio.ibkrCash) }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Stocks</span>
                                <span class="font-semibold">Â£{{ formatNumber(portfolio.ibkrStocks) }}</span>
                            </div>
                            <div v-if="portfolio.ibkrInvested > 0" class="pt-2 mt-2 border-t border-gray-200">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-gray-600">Invested</span>
                                    <span class="font-semibold">Â£{{ formatNumber(portfolio.ibkrInvested) }}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Unrealised P/L</span>
                                    <span class="font-semibold" :class="{
                                        'text-green-600': portfolio.ibkrPL > 0,
                                        'text-red-600': portfolio.ibkrPL < 0
                                    }">
                                        {{ portfolio.ibkrPL >= 0 ? '+' : '' }}Â£{{ formatNumber(portfolio.ibkrPL) }}
                                        ({{ portfolio.ibkrPL >= 0 ? '+' : '' }}{{ portfolio.ibkrPLPercent.toFixed(2) }}%)
                                    </span>
                                </div>
                            </div>
                            <div v-if="portfolio.ibkrRealisedPL !== 0" class="pt-2 mt-2 border-t border-gray-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Realised P/L</span>
                                    <span class="font-semibold" :class="{
                                        'text-green-600': portfolio.ibkrRealisedPL > 0,
                                        'text-red-600': portfolio.ibkrRealisedPL < 0
                                    }">
                                        {{ portfolio.ibkrRealisedPL >= 0 ? '+' : '' }}Â£{{ formatNumber(Math.abs(portfolio.ibkrRealisedPL)) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Cash (if exists) -->
                    <div v-if="portfolio.manualTotal > 0" class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-gray-900">Manual Cash</h4>
                            <span class="text-lg font-bold text-green-600">Â£{{ formatNumber(portfolio.manualTotal) }}</span>
                        </div>
                        <p class="text-xs text-gray-500">100% Cash</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Target Percentage Reference Table -->
        <div v-if="targetValue > 0" class="bg-white rounded-lg shadow p-6">
            <!-- Header with refresh button -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Target Value Reference</h3>
                <div class="flex items-center gap-3">
                    <!-- Last update time -->
                    <span v-if="lastExchangeRateUpdate" class="text-xs text-gray-500">
                        Updated {{ new Date(lastExchangeRateUpdate).toLocaleTimeString() }}
                    </span>
                    <!-- Refresh button -->
                    <button
                        @click="refreshExchangeRate"
                        :disabled="exchangeRateLoading"
                        class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50"
                        title="Refresh exchange rate"
                    >
                        <svg
                            :class="{'animate-spin': exchangeRateLoading}"
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Error message -->
            <div v-if="exchangeRateError" class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm text-yellow-800">{{ exchangeRateError }}</p>
            </div>

            <!-- Percentage input and result -->
            <div class="flex flex-col md:flex-row gap-6 items-center">
                <!-- Input section -->
                <div class="flex-shrink-0">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Target % for new stock</label>
                    <div class="flex items-center gap-2">
                        <input
                            v-model.number="targetReferencePercentage"
                            type="number"
                            step="0.1"
                            min="0"
                            max="100"
                            class="w-32 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-right"
                        >
                        <span class="text-gray-600 font-medium">%</span>
                    </div>
                </div>

                <!-- Result display -->
                <div class="flex-1 border border-gray-200 rounded-lg p-4 md:p-6 bg-gray-50 min-w-0">
                    <div class="text-sm text-gray-600 mb-2">
                        Target invested amount (Cost Basis) for {{ targetReferencePercentage }}%:
                    </div>
                    <div class="text-xs text-gray-500 mb-3">
                        Adjusted for {{ targetCashPercentage }}% cash = {{ ((targetReferencePercentage / (existingHoldingsTargetPctTotal + targetReferencePercentage)) * (100 - (targetCashPercentage || 0))).toFixed(2) }}% adjusted target
                    </div>
                    <div class="space-y-2">
                        <!-- GBP value -->
                        <div class="flex items-baseline gap-2 flex-wrap">
                            <span class="text-2xl md:text-3xl font-bold text-gray-900 break-all">
                                Â£{{ formatNumber((targetValue * ((targetReferencePercentage / (existingHoldingsTargetPctTotal + targetReferencePercentage)) * (100 - (targetCashPercentage || 0)))) / 100) }}
                            </span>
                            <span class="text-sm text-gray-500">GBP</span>
                        </div>
                        <!-- USD value -->
                        <div class="flex items-baseline gap-2 flex-wrap">
                            <span class="text-xl md:text-2xl font-semibold text-gray-700 break-all">
                                ${{ formatNumber((targetValue * ((targetReferencePercentage / (existingHoldingsTargetPctTotal + targetReferencePercentage)) * (100 - (targetCashPercentage || 0)))) / 100 * gbpUsdRate) }}
                            </span>
                            <span class="text-sm text-gray-500">USD</span>
                        </div>
                    </div>
                    <div class="mt-3 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-800">
                        ðŸ’¡ Enter this as your Cost Basis to show Â£0 in Adjusted Diff Â£
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Holdings Entry -->
        <div class="bg-white rounded-lg shadow p-4 md:p-6 mb-8 mt-8">
            <div class="mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Manual Stock/ETF Holdings</h2>
                <p class="text-sm text-gray-600 mt-1">Track positions from other brokers or platforms not imported via CSV</p>
            </div>
            <div class="space-y-4">
                <div v-for="(entry, index) in manualHoldings" :key="index" class="border border-gray-200 rounded-lg p-3 md:p-4 bg-gray-50">
                    <div class="flex flex-col gap-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Ticker Symbol *</label>
                                <input
                                    v-model="entry.symbol"
                                    type="text"
                                    placeholder="e.g. AAPL, VOO"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm uppercase"
                                >
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Name (Optional)</label>
                                <input
                                    v-model="entry.name"
                                    type="text"
                                    placeholder="e.g. Apple Inc."
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                >
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">
                                    Current Value *
                                    <span class="font-normal text-gray-500" title="What your position is worth today at current market prices">â“˜</span>
                                </label>
                                <div class="flex gap-1 min-w-0">
                                    <input
                                        v-model.number="entry.currentValue"
                                        type="number"
                                        placeholder="5000.00"
                                        step="0.01"
                                        class="flex-1 min-w-0 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                    >
                                    <select
                                        v-model="entry.currentValueCurrency"
                                        class="px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm bg-white flex-shrink-0"
                                    >
                                        <option value="GBP">Â£</option>
                                        <option value="USD">$</option>
                                    </select>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Today's market value</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">
                                    Cost Basis (Optional)
                                    <span class="font-normal text-gray-500" title="What you originally paid when you bought it">â“˜</span>
                                </label>
                                <div class="flex gap-1 min-w-0">
                                    <input
                                        v-model.number="entry.costBasis"
                                        type="number"
                                        placeholder="4500.00"
                                        step="0.01"
                                        class="flex-1 min-w-0 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                    >
                                    <select
                                        v-model="entry.costBasisCurrency"
                                        class="px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm bg-white flex-shrink-0"
                                    >
                                        <option value="GBP">Â£</option>
                                        <option value="USD">$</option>
                                    </select>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Original purchase price</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button
                                @click="removeManualHolding(index)"
                                class="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition text-sm flex items-center gap-1"
                                title="Remove this holding"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                                <span class="text-xs">Remove</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div v-if="manualHoldings.length === 0" class="text-center py-8 text-gray-500 text-sm">
                    No manual holdings added yet. Click "+ Add Holding" to track positions from other brokers.
                </div>
            </div>
            <button
                @click="addManualHolding"
                class="mt-4 w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm flex items-center justify-center gap-2"
            >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Add Holding
            </button>
        </div>

        <!-- Holdings Table -->
        <div v-if="portfolio.holdings.length > 0" class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-4 md:px-6 py-4 border-b border-gray-200">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <h2 class="text-xl font-semibold text-gray-800">Holdings</h2>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 md:gap-4">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600">Target Value:</label>
                        <input
                            v-model.number="targetValue"
                            type="number"
                            placeholder="e.g. 100000"
                            step="1000"
                            class="w-32 px-3 py-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600">Target Cash %:</label>
                        <input
                            v-model.number="targetCashPercentage"
                            type="number"
                            placeholder="e.g. 10"
                            step="0.1"
                            min="0"
                            max="100"
                            class="w-20 px-3 py-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                        <span class="text-sm text-gray-600">%</span>
                    </div>
                    <button
                        @click="refreshAllPrices"
                        :disabled="pricesLoading"
                        class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-2 focus:ring-blue-500 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        :class="{ 'bg-blue-50': pricesLoading }"
                    >
                        <svg :class="{ 'animate-spin': pricesLoading }" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span v-if="pricesLoading">Refreshing...</span>
                        <span v-else>Refresh Prices</span>
                    </button>
                    <button
                        v-if="t212Holdings.length > 0"
                        @click="showDebugPanel = !showDebugPanel"
                        class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-2 focus:ring-blue-500 flex items-center gap-2"
                        :class="{ 'bg-yellow-50 border-yellow-400': showDebugPanel }"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        Debug
                    </button>
                    <div class="relative">
                        <button
                            @click="showColumnSelector = !showColumnSelector"
                            class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-2 focus:ring-blue-500 flex items-center gap-2"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                            Columns
                        </button>
                        <div
                            v-if="showColumnSelector"
                            @click.stop
                            class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 z-10 p-3"
                        >
                            <div class="text-xs font-semibold text-gray-700 mb-2 pb-2 border-b border-gray-200">
                                Show/Hide Columns
                            </div>
                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" v-model="visibleColumns.avgPrice" class="rounded">
                                    <span class="text-sm text-gray-700">Avg Price $</span>
                                </label>
                                <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" v-model="visibleColumns.currentPrice" class="rounded">
                                    <span class="text-sm text-gray-700">Current Price $</span>
                                </label>
                                <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" v-model="visibleColumns.invested" class="rounded">
                                    <span class="text-sm text-gray-700">Invested</span>
                                </label>
                                <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" v-model="visibleColumns.pl" class="rounded">
                                    <span class="text-sm text-gray-700">P/L</span>
                                </label>
                                <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                                    <input type="checkbox" v-model="visibleColumns.plPercent" class="rounded">
                                    <span class="text-sm text-gray-700">P/L %</span>
                                </label>
                                <template v-if="targetValue > 0">
                                    <div class="text-xs font-semibold text-gray-600 mt-3 mb-1 pt-2 border-t border-gray-100">
                                        Target Columns
                                    </div>
                                    <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                                        <input type="checkbox" v-model="visibleColumns.percentInvested" class="rounded">
                                        <span class="text-sm text-gray-700">% Invested</span>
                                    </label>
                                    <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                                        <input type="checkbox" v-model="visibleColumns.targetPercent" class="rounded">
                                        <span class="text-sm text-gray-700">Target %</span>
                                    </label>
                                    <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                                        <input type="checkbox" v-model="visibleColumns.diffPercent" class="rounded">
                                        <span class="text-sm text-gray-700">Diff %</span>
                                    </label>
                                    <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                                        <input type="checkbox" v-model="visibleColumns.diffGbp" class="rounded">
                                        <span class="text-sm text-gray-700">Diff Â£</span>
                                    </label>
                                    <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                                        <input type="checkbox" v-model="visibleColumns.adjustedTargetPct" class="rounded">
                                        <span class="text-sm text-gray-700">Adjusted Target %</span>
                                    </label>
                                    <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                                        <input type="checkbox" v-model="visibleColumns.adjustedDiffPercent" class="rounded">
                                        <span class="text-sm text-gray-700">Adjusted Diff %</span>
                                    </label>
                                    <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                                        <input type="checkbox" v-model="visibleColumns.adjustedDiffGbp" class="rounded">
                                        <span class="text-sm text-gray-700">Adjusted Diff Â£</span>
                                    </label>
                                    <label class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded cursor-pointer">
                                        <input type="checkbox" v-model="visibleColumns.adjustedDiffUsd" class="rounded">
                                        <span class="text-sm text-gray-700">Adjusted Diff $</span>
                                    </label>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Mobile: Card View -->
            <div class="md:hidden divide-y divide-gray-200">
                <div
                    v-for="holding in sortedHoldings"
                    :key="holding.symbol + holding.source"
                    class="p-4 hover:bg-gray-50"
                >
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-base text-gray-900">{{ holding.symbol }}</h3>
                            <p v-if="holding.name && holding.name !== holding.symbol" class="text-xs text-gray-500 mt-0.5">{{ holding.name }}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs px-2 py-1 rounded font-medium" :class="{
                                'bg-purple-100 text-purple-800': holding.source === 't212',
                                'bg-blue-100 text-blue-800': holding.source === 'ibkr',
                                'bg-green-100 text-green-800': holding.source === 'manual',
                                'bg-gray-100 text-gray-800': holding.source === 'multiple'
                            }">
                                {{ holding.source === 't212' ? 'T212' : holding.source === 'ibkr' ? 'IBKR' : holding.source === 'manual' ? 'Manual' : 'Multiple' }}
                            </span>
                            <button
                                @click="removeHolding(holding)"
                                class="p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg focus:outline-none active:bg-red-100"
                                title="Remove this holding"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <span class="text-gray-500 text-xs">Value</span>
                            <p class="font-semibold text-gray-900">Â£{{ formatNumber(holding.valueGBP || 0) }}</p>
                        </div>
                        <div v-if="holding.costBasisGBP">
                            <span class="text-gray-500 text-xs">Invested</span>
                            <p class="font-medium text-gray-700">Â£{{ formatNumber(holding.costBasisGBP) }}</p>
                        </div>
                        <div v-if="holding.currentPrice && holding.type !== 'cash'">
                            <span class="text-gray-500 text-xs">Current Price</span>
                            <p class="font-medium text-gray-700">{{ holding.currentPriceCurrency === 'GBP' ? 'Â£' : '$' }}{{ formatNumber(holding.currentPrice) }}</p>
                        </div>
                        <div v-if="targetValue > 0 && holding.adjustedGbpDiff !== undefined">
                            <span class="text-gray-500 text-xs">Adjusted Diff Â£</span>
                            <p class="font-semibold" :class="{
                                'text-green-600': holding.adjustedGbpDiff > 50,
                                'text-red-600': holding.adjustedGbpDiff < -50,
                                'text-gray-600': Math.abs(holding.adjustedGbpDiff) <= 50
                            }">
                                {{ holding.adjustedGbpDiff >= 0 ? '+' : '' }}Â£{{ formatNumber(Math.abs(holding.adjustedGbpDiff)) }}
                            </p>
                        </div>
                        <div v-if="targetValue > 0 && holding.adjustedPercentDiff !== undefined">
                            <span class="text-gray-500 text-xs">Adjusted Diff %</span>
                            <p class="font-semibold" :class="{
                                'text-green-600': holding.adjustedPercentDiff > 0.5,
                                'text-red-600': holding.adjustedPercentDiff < -0.5,
                                'text-gray-600': Math.abs(holding.adjustedPercentDiff) <= 0.5
                            }">
                                {{ holding.adjustedPercentDiff >= 0 ? '+' : '' }}{{ holding.adjustedPercentDiff.toFixed(2) }}%
                            </p>
                        </div>
                        <div v-if="targetValue > 0 && holding.adjustedGbpDiff !== undefined && targetPercentages[holding.symbol]">
                            <span class="text-gray-500 text-xs">Adjusted Diff $</span>
                            <p class="font-semibold" :class="{
                                'text-green-600': holding.adjustedGbpDiff > 50,
                                'text-red-600': holding.adjustedGbpDiff < -50,
                                'text-gray-600': Math.abs(holding.adjustedGbpDiff) <= 50
                            }">
                                {{ holding.adjustedGbpDiff >= 0 ? '+' : '' }}${{ formatNumber(Math.abs(holding.adjustedGbpDiff * gbpUsdRate)) }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Desktop: Table View -->
            <div class="hidden md:block overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th @click="sortBy('symbol')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                Symbol {{ sortField === 'symbol' ? (sortAsc ? 'â†‘' : 'â†“') : '' }}
                            </th>
                            <th v-if="visibleColumns.avgPrice" @click="sortBy('avgPriceGBP')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                Avg Price $ {{ sortField === 'avgPriceGBP' ? (sortAsc ? 'â†‘' : 'â†“') : '' }}
                            </th>
                            <th v-if="visibleColumns.currentPrice" @click="sortBy('currentPrice')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                Current Price $ {{ sortField === 'currentPrice' ? (sortAsc ? 'â†‘' : 'â†“') : '' }}
                            </th>
                            <th v-if="visibleColumns.invested" @click="sortBy('costBasisGBP')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                Invested {{ sortField === 'costBasisGBP' ? (sortAsc ? 'â†‘' : 'â†“') : '' }}
                            </th>
                            <th v-if="visibleColumns.pl" @click="sortBy('unrealizedPL')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                P/L {{ sortField === 'unrealizedPL' ? (sortAsc ? 'â†‘' : 'â†“') : '' }}
                            </th>
                            <th v-if="visibleColumns.plPercent" @click="sortBy('unrealizedPLPercent')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                P/L % {{ sortField === 'unrealizedPLPercent' ? (sortAsc ? 'â†‘' : 'â†“') : '' }}
                            </th>
                            <th v-if="targetValue > 0 && visibleColumns.percentInvested" @click="sortBy('percentInvested')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                % Invested {{ sortField === 'percentInvested' ? (sortAsc ? 'â†‘' : 'â†“') : '' }}
                            </th>
                            <th v-if="targetValue > 0 && visibleColumns.targetPercent" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Target %
                            </th>
                            <th v-if="targetValue > 0 && visibleColumns.diffPercent" @click="sortBy('percentDiff')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                Diff % {{ sortField === 'percentDiff' ? (sortAsc ? 'â†‘' : 'â†“') : '' }}
                            </th>
                            <th v-if="targetValue > 0 && visibleColumns.diffGbp" @click="sortBy('gbpDiff')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                Diff Â£ {{ sortField === 'gbpDiff' ? (sortAsc ? 'â†‘' : 'â†“') : '' }}
                            </th>
                            <th v-if="targetValue > 0 && visibleColumns.adjustedTargetPct" @click="sortBy('adjustedTargetPct')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                Adjusted Target % {{ sortField === 'adjustedTargetPct' ? (sortAsc ? 'â†‘' : 'â†“') : '' }}
                            </th>
                            <th v-if="targetValue > 0 && visibleColumns.adjustedDiffPercent" @click="sortBy('adjustedPercentDiff')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                Adjusted Diff % {{ sortField === 'adjustedPercentDiff' ? (sortAsc ? 'â†‘' : 'â†“') : '' }}
                            </th>
                            <th v-if="targetValue > 0 && visibleColumns.adjustedDiffGbp" @click="sortBy('adjustedGbpDiff')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                Adjusted Diff Â£ {{ sortField === 'adjustedGbpDiff' ? (sortAsc ? 'â†‘' : 'â†“') : '' }}
                            </th>
                            <th v-if="targetValue > 0 && visibleColumns.adjustedDiffUsd" @click="sortBy('adjustedUsdDiff')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                Adjusted Diff $ {{ sortField === 'adjustedUsdDiff' ? (sortAsc ? 'â†‘' : 'â†“') : '' }}
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Source
                            </th>
                            <th class="sticky right-0 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 shadow-[-2px_0_4px_rgba(0,0,0,0.05)]">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr v-for="holding in sortedHoldings" :key="holding.symbol + holding.source" class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ holding.symbol }}
                            </td>
                            <td v-if="visibleColumns.avgPrice" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">
                                <span v-if="holding.type === 'cash'">-</span>
                                <span v-else-if="holding.avgPriceNative">
                                    {{ holding.nativeCurrency === 'GBP' ? 'Â£' : '$' }}{{ formatNumber(holding.avgPriceNative) }}
                                </span>
                                <span v-else-if="holding.avgPriceGBP">${{ formatNumber(holding.avgPriceGBP * gbpUsdRate) }}</span>
                                <span v-else>-</span>
                            </td>
                            <td v-if="visibleColumns.currentPrice" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">
                                <span v-if="holding.type === 'cash'">-</span>
                                <span v-else-if="holding.currentPrice">
                                    {{ holding.currentPriceCurrency === 'GBP' ? 'Â£' : '$' }}{{ formatNumber(holding.currentPrice) }}
                                </span>
                                <span v-else>-</span>
                            </td>
                            <td v-if="visibleColumns.invested" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">
                                <span v-if="holding.type === 'cash'">-</span>
                                <div v-else class="flex items-center justify-end gap-1">
                                    <span v-if="holding.usingOriginalCost"
                                          class="text-purple-500 text-xs"
                                          title="Using original cost basis (preserved across broker transfers)">â˜…</span>
                                    <span class="text-gray-500">Â£</span>
                                    <input
                                        :value="costBasisOverrides[holding.symbol] !== undefined ? costBasisOverrides[holding.symbol] : (holding.costBasisGBP || '')"
                                        @input="costBasisOverrides[holding.symbol] = $event.target.value"
                                        @change="saveToStorage"
                                        type="number"
                                        step="0.01"
                                        min="0"
                                        placeholder="0"
                                        class="w-24 px-2 py-1 text-xs text-right border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                                    >
                                </div>
                            </td>
                            <td v-if="visibleColumns.pl" class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium" :class="{
                                'text-green-600': holding.unrealizedPL > 0,
                                'text-red-600': holding.unrealizedPL < 0,
                                'text-gray-700': holding.unrealizedPL === 0 || holding.type === 'cash'
                            }">
                                <span v-if="holding.type === 'cash'">-</span>
                                <span v-else-if="holding.unrealizedPL !== undefined">
                                    {{ holding.unrealizedPL >= 0 ? '+' : '' }}Â£{{ formatNumber(holding.unrealizedPL) }}
                                </span>
                                <span v-else>-</span>
                            </td>
                            <td v-if="visibleColumns.plPercent" class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium" :class="{
                                'text-green-600': holding.unrealizedPLPercent > 0,
                                'text-red-600': holding.unrealizedPLPercent < 0,
                                'text-gray-700': holding.unrealizedPLPercent === 0 || holding.type === 'cash'
                            }">
                                <span v-if="holding.type === 'cash'">-</span>
                                <span v-else-if="holding.unrealizedPLPercent !== undefined">
                                    {{ holding.unrealizedPLPercent >= 0 ? '+' : '' }}{{ holding.unrealizedPLPercent.toFixed(2) }}%
                                </span>
                                <span v-else>-</span>
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.percentInvested" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">
                                <span v-if="holding.percentInvested !== undefined">{{ holding.percentInvested.toFixed(2) }}%</span>
                                <span v-else>-</span>
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.targetPercent" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">
                                <input
                                    v-model.number="targetPercentages[holding.symbol]"
                                    @change="saveToStorage"
                                    type="number"
                                    step="0.1"
                                    min="0"
                                    max="100"
                                    placeholder="0"
                                    class="w-16 px-2 py-1 text-xs text-right border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                                >
                                <span class="ml-1">%</span>
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.diffPercent" class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium" :class="{
                                'text-red-600': holding.percentDiff < -0.5,
                                'text-green-600': holding.percentDiff > 0.5,
                                'text-gray-700': Math.abs(holding.percentDiff) <= 0.5
                            }">
                                <span v-if="targetPercentages[holding.symbol]">
                                    {{ holding.percentDiff >= 0 ? '+' : '' }}{{ holding.percentDiff.toFixed(2) }}%
                                </span>
                                <span v-else>-</span>
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.diffGbp" class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium" :class="{
                                'text-red-600': holding.gbpDiff < -50,
                                'text-green-600': holding.gbpDiff > 50,
                                'text-gray-700': Math.abs(holding.gbpDiff) <= 50
                            }">
                                <span v-if="targetPercentages[holding.symbol]">
                                    {{ holding.gbpDiff >= 0 ? '+' : '' }}Â£{{ formatNumber(Math.abs(holding.gbpDiff)) }}
                                </span>
                                <span v-else>-</span>
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.adjustedTargetPct" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">
                                <span v-if="targetPercentages[holding.symbol]">
                                    {{ holding.adjustedTargetPct.toFixed(2) }}%
                                </span>
                                <span v-else>-</span>
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.adjustedDiffPercent" class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium" :class="{
                                'text-red-600': holding.adjustedPercentDiff < -0.5,
                                'text-green-600': holding.adjustedPercentDiff > 0.5,
                                'text-gray-700': Math.abs(holding.adjustedPercentDiff) <= 0.5
                            }">
                                <span v-if="targetPercentages[holding.symbol]">
                                    {{ holding.adjustedPercentDiff >= 0 ? '+' : '' }}{{ holding.adjustedPercentDiff.toFixed(2) }}%
                                </span>
                                <span v-else>-</span>
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.adjustedDiffGbp" class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium" :class="{
                                'text-red-600': holding.adjustedGbpDiff < -50,
                                'text-green-600': holding.adjustedGbpDiff > 50,
                                'text-gray-700': Math.abs(holding.adjustedGbpDiff) <= 50
                            }">
                                <span v-if="targetPercentages[holding.symbol]">
                                    {{ holding.adjustedGbpDiff >= 0 ? '+' : '' }}Â£{{ formatNumber(Math.abs(holding.adjustedGbpDiff)) }}
                                </span>
                                <span v-else>-</span>
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.adjustedDiffUsd" class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium" :class="{
                                'text-red-600': holding.adjustedGbpDiff < -50,
                                'text-green-600': holding.adjustedGbpDiff > 50,
                                'text-gray-700': Math.abs(holding.adjustedGbpDiff) <= 50
                            }">
                                <span v-if="targetPercentages[holding.symbol]">
                                    {{ holding.adjustedGbpDiff >= 0 ? '+' : '' }}${{ formatNumber(Math.abs(holding.adjustedGbpDiff * gbpUsdRate)) }}
                                </span>
                                <span v-else>-</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" :class="{
                                    'bg-blue-100 text-blue-800': holding.source === 'ibkr',
                                    'bg-purple-100 text-purple-800': holding.source === 't212',
                                    'bg-green-100 text-green-800': holding.source === 'manual',
                                    'bg-gray-100 text-gray-800': holding.source.includes('+')
                                }">
                                    {{ holding.source }}
                                </span>
                            </td>
                            <td class="sticky right-0 px-2 py-4 whitespace-nowrap text-sm text-center bg-white shadow-[-2px_0_4px_rgba(0,0,0,0.05)]">
                                <button
                                    @click="removeHolding(holding)"
                                    class="inline-flex items-center justify-center p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 active:bg-red-100 transition-colors"
                                    title="Remove this holding"
                                >
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot class="bg-gray-50 border-t-2 border-gray-300">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                                TOTAL
                            </td>
                            <td v-if="visibleColumns.avgPrice" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">
                                -
                            </td>
                            <td v-if="visibleColumns.invested" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 text-right">
                                Â£{{ formatNumber(sortedHoldings.reduce((sum, h) => sum + (h.costBasisGBP || 0), 0)) }}
                            </td>
                            <td v-if="visibleColumns.pl" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-right" :class="{
                                'text-green-600': sortedHoldings.reduce((sum, h) => sum + (h.unrealizedPL || 0), 0) > 0,
                                'text-red-600': sortedHoldings.reduce((sum, h) => sum + (h.unrealizedPL || 0), 0) < 0,
                                'text-gray-900': sortedHoldings.reduce((sum, h) => sum + (h.unrealizedPL || 0), 0) === 0
                            }">
                                <span>
                                    {{ sortedHoldings.reduce((sum, h) => sum + (h.unrealizedPL || 0), 0) >= 0 ? '+' : '' }}Â£{{ formatNumber(Math.abs(sortedHoldings.reduce((sum, h) => sum + (h.unrealizedPL || 0), 0))) }}
                                </span>
                            </td>
                            <td v-if="visibleColumns.plPercent" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-right" :class="{
                                'text-green-600': (sortedHoldings.reduce((sum, h) => sum + (h.unrealizedPL || 0), 0) / sortedHoldings.reduce((sum, h) => sum + (h.costBasisGBP || 0), 0) * 100) > 0,
                                'text-red-600': (sortedHoldings.reduce((sum, h) => sum + (h.unrealizedPL || 0), 0) / sortedHoldings.reduce((sum, h) => sum + (h.costBasisGBP || 0), 0) * 100) < 0,
                                'text-gray-900': (sortedHoldings.reduce((sum, h) => sum + (h.unrealizedPL || 0), 0) / sortedHoldings.reduce((sum, h) => sum + (h.costBasisGBP || 0), 0) * 100) === 0
                            }">
                                {{ (sortedHoldings.reduce((sum, h) => sum + (h.unrealizedPL || 0), 0) / sortedHoldings.reduce((sum, h) => sum + (h.costBasisGBP || 0), 0) * 100) >= 0 ? '+' : '' }}{{ ((sortedHoldings.reduce((sum, h) => sum + (h.unrealizedPL || 0), 0) / sortedHoldings.reduce((sum, h) => sum + (h.costBasisGBP || 0), 0)) * 100).toFixed(2) }}%
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.percentInvested" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 text-right">
                                {{ ((sortedHoldings.reduce((sum, h) => sum + (h.costBasisGBP || 0), 0) / targetValue) * 100).toFixed(2) }}%
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.targetPercent" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-right" :class="{
                                'text-green-600': existingHoldingsTargetPctTotal < 100,
                                'text-red-600': existingHoldingsTargetPctTotal > 100,
                                'text-gray-900': existingHoldingsTargetPctTotal === 100
                            }">
                                {{ existingHoldingsTargetPctTotal.toFixed(2) }}%
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.diffPercent" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">
                                -
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.diffGbp" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-right" :class="{
                                'text-red-600': sortedHoldings.reduce((sum, h) => sum + (h.gbpDiff || 0), 0) < -50,
                                'text-green-600': sortedHoldings.reduce((sum, h) => sum + (h.gbpDiff || 0), 0) > 50,
                                'text-gray-900': Math.abs(sortedHoldings.reduce((sum, h) => sum + (h.gbpDiff || 0), 0)) <= 50
                            }">
                                {{ sortedHoldings.reduce((sum, h) => sum + (h.gbpDiff || 0), 0) >= 0 ? '+' : '' }}Â£{{ formatNumber(Math.abs(sortedHoldings.reduce((sum, h) => sum + (h.gbpDiff || 0), 0))) }}
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.adjustedTargetPct" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 text-right">
                                {{ (100 - (targetCashPercentage || 0)).toFixed(2) }}%
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.adjustedDiffPercent" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">
                                -
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.adjustedDiffGbp" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">
                                -
                            </td>
                            <td v-if="targetValue > 0 && visibleColumns.adjustedDiffUsd" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">
                                -
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                -
                            </td>
                            <td class="sticky right-0 px-6 py-4 whitespace-nowrap text-sm text-gray-600 bg-gray-50 shadow-[-2px_0_4px_rgba(0,0,0,0.05)]">
                                -
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Debug Panel -->
        <div v-if="showDebugPanel" class="bg-yellow-50 border border-yellow-200 rounded-lg shadow p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Calculation Debug (Combined)</h2>
                <button @click="showDebugPanel = false" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Empty state -->
            <div v-if="t212Holdings.length === 0 && ibkrHoldings.length === 0" class="text-center py-8">
                <p class="text-gray-600 mb-2">No debug data available.</p>
                <p class="text-sm text-gray-500">Please upload your CSV files to generate the calculation breakdown.</p>
            </div>

            <!-- Combined Summary -->
            <template v-if="t212Holdings.length > 0 || ibkrHoldings.length > 0">
                <h3 class="text-md font-semibold text-gray-700 mb-3 border-b border-gray-300 pb-2">Portfolio Summary</h3>
                <div class="mb-4 p-3 bg-white rounded border border-yellow-100">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500">Total Invested:</span>
                            <span class="font-medium ml-1">Â£{{ formatNumber(
                                [...t212Holdings, ...ibkrHoldings].filter(h => h.type !== 'cash').reduce((sum, h) => sum + (h.costBasisGBP || 0), 0)
                            ) }}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Total Value:</span>
                            <span class="font-medium ml-1">Â£{{ formatNumber(
                                [...t212Holdings, ...ibkrHoldings].filter(h => h.type !== 'cash').reduce((sum, h) => sum + (h.valueGBP || 0), 0)
                            ) }}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Total Cash:</span>
                            <span class="font-medium ml-1">Â£{{ formatNumber(
                                [...t212Holdings, ...ibkrHoldings].filter(h => h.type === 'cash').reduce((sum, h) => sum + (h.valueGBP || 0), 0)
                            ) }}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Total P/L:</span>
                            <span class="font-medium ml-1" :class="[...t212Holdings, ...ibkrHoldings].filter(h => h.type !== 'cash').reduce((sum, h) => sum + (h.unrealizedPL || 0), 0) >= 0 ? 'text-green-600' : 'text-red-600'">
                                Â£{{ formatNumber([...t212Holdings, ...ibkrHoldings].filter(h => h.type !== 'cash').reduce((sum, h) => sum + (h.unrealizedPL || 0), 0)) }}
                            </span>
                        </div>
                        <div>
                            <span class="text-gray-500">Transactions:</span>
                            <span class="font-medium ml-1">{{ t212Transactions.length + ibkrTransactions.length }}</span>
                            <span class="text-xs text-gray-400 ml-1">({{ t212Transactions.filter(t => t.type === 'buy').length + ibkrTransactions.filter(t => t.type === 'buy').length }} buys, {{ t212Transactions.filter(t => t.type === 'sell').length + ibkrTransactions.filter(t => t.type === 'sell').length }} sells)</span>
                        </div>
                    </div>
                </div>

                <!-- Per-Stock Breakdown -->
                <h3 class="text-md font-semibold text-gray-700 mb-3 border-b border-gray-300 pb-2">Stock Breakdown</h3>
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    <div v-for="stock in combinedDebugStocks" :key="stock.symbol" class="p-3 bg-white rounded border border-yellow-100">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-medium text-gray-800">{{ stock.symbol }}</h3>
                            <div class="flex gap-1">
                                <span v-if="stock.sources.includes('t212')" class="text-xs px-2 py-0.5 rounded bg-purple-100 text-purple-700">T212</span>
                                <span v-if="stock.sources.includes('ibkr')" class="text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700">IBKR</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                            <div>
                                <span class="text-gray-500">Total Shares:</span>
                                <span class="font-mono ml-1">{{ stock.totalShares.toFixed(4) }}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Cost Basis:</span>
                                <span class="font-mono ml-1">Â£{{ stock.costBasisGBP.toFixed(2) }}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Value:</span>
                                <span class="font-mono ml-1">Â£{{ stock.valueGBP.toFixed(2) }}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">P/L:</span>
                                <span class="font-mono ml-1" :class="stock.pl >= 0 ? 'text-green-600' : 'text-red-600'">
                                    Â£{{ stock.pl.toFixed(2) }} ({{ stock.plPercent.toFixed(1) }}%)
                                </span>
                            </div>
                        </div>
                        <!-- Transaction count from calculated cost basis -->
                        <div v-if="stock.transactionCount > 0" class="mt-2 pt-2 border-t border-gray-100 text-xs text-gray-500">
                            {{ stock.transactionCount }} transactions
                            <span v-if="stock.t212TxCount > 0 && stock.ibkrTxCount > 0">
                                ({{ stock.t212TxCount }} T212, {{ stock.ibkrTxCount }} IBKR)
                            </span>
                            <span v-else-if="stock.t212TxCount > 0"> from T212</span>
                            <span v-else-if="stock.ibkrTxCount > 0"> from IBKR</span>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Empty State -->
        <div v-if="portfolio.holdings.length === 0" class="bg-white rounded-lg shadow p-12 text-center">
            <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No data yet</h3>
            <p class="text-gray-600">Upload your CSV files or add manual cash entries to get started</p>
        </div>

        <!-- Authentication Modal (blocking overlay when not authenticated) -->
        <div v-if="showAuthModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">
                    {{ isLogin ? 'Login' : 'Sign Up' }}
                </h2>
                <p class="text-gray-600 mb-6">
                    Sign in to sync your portfolio across devices
                </p>
                <div class="space-y-4">
                    <input
                        v-model="authEmail"
                        type="email"
                        placeholder="Email"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        @keyup.enter="isLogin ? login() : signup()"
                    >
                    <input
                        v-model="authPassword"
                        type="password"
                        placeholder="Password (min 6 characters)"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        @keyup.enter="isLogin ? login() : signup()"
                    >
                    <button
                        @click="isLogin ? login() : signup()"
                        class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-medium"
                    >
                        {{ isLogin ? 'Login' : 'Sign Up' }}
                    </button>
                    <button
                        @click="isLogin = !isLogin"
                        class="w-full text-blue-600 text-sm hover:underline"
                    >
                        {{ isLogin ? 'Need an account? Sign up' : 'Have an account? Login' }}
                    </button>
                </div>
                <div v-if="syncError" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-800">{{ syncError }}</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                // Data is loaded from Firebase after login - start with empty defaults
                return {
                    // File upload state
                    t212File: null,
                    t212RowCount: 0,
                    t212Error: null,
                    t212Holdings: [],
                    t212Loading: false,
                    t212Dragging: false,

                    ibkrFile: null,
                    ibkrRowCount: 0,
                    ibkrError: null,
                    ibkrHoldings: [],
                    ibkrLoading: false,
                    ibkrDragging: false,

                    // Price refresh state
                    pricesLoading: false,
                    lastPriceUpdate: null,

                    // Manual cash entries
                    manualCashEntries: [],

                    // Manual holdings entries
                    manualHoldings: [],

                    // Target value for percentage calculation
                    targetValue: 0,

                    // Target percentages for each stock
                    targetPercentages: {},

                    // Cost basis overrides for editing invested amounts
                    costBasisOverrides: {},

                    // Transaction history from both brokers (for cost basis calculation)
                    t212Transactions: [],
                    ibkrTransactions: [],

                    // Target cash percentage
                    targetCashPercentage: 0,

                    // Realised profits (manually entered)
                    realisedProfits: {
                        t212: 0,
                        ibkr: 0
                    },

                    // Target reference percentage
                    targetReferencePercentage: 5,

                    // Column visibility
                    visibleColumns: {
                        avgPrice: true,
                        currentPrice: true,
                        invested: true,
                        pl: true,
                        plPercent: true,
                        percentInvested: true,
                        targetPercent: true,
                        diffPercent: true,
                        diffGbp: true,
                        adjustedTargetPct: true,
                        adjustedDiffPercent: true,
                        adjustedDiffGbp: true,
                        adjustedDiffUsd: true
                    },
                    showColumnSelector: false,
                    showDebugPanel: false,
                    t212DebugLog: [],  // Transaction log for debugging

                    // Sorting
                    sortField: 'valueGBP',
                    sortAsc: false,

                    // Auth state
                    user: null,
                    showAuthModal: false,
                    authEmail: '',
                    authPassword: '',
                    isLogin: true,

                    // Sync state
                    syncStatus: 'offline', // 'synced' | 'syncing' | 'offline' | 'error'
                    syncError: null,
                    lastSyncTime: null,

                    // PWA install
                    showInstallPrompt: false,
                    deferredPrompt: null,

                    // Exchange rate state
                    gbpUsdRate: 1.27,              // Default USD rate as fallback
                    gbpCadRate: 1.78,              // Default CAD rate as fallback
                    exchangeRateLoading: false,   // Loading state for API call
                    exchangeRateError: null,      // Error message if fetch fails
                    lastExchangeRateUpdate: null, // Timestamp of last successful fetch
                    exchangeRateCacheExpiry: 3600000,  // Cache for 1 hour (milliseconds)

                    // Internal flags (not synced to Firebase)
                    _isProcessingLocalChange: false,
                    _hasLoadedFromCloud: false
                };
            },
            watch: {
                t212Holdings: {
                    handler() {
                        if (!this._isProcessingLocalChange) this.saveToStorage();
                    },
                    deep: true
                },
                ibkrHoldings: {
                    handler() {
                        if (!this._isProcessingLocalChange) this.saveToStorage();
                    },
                    deep: true
                },
                manualCashEntries: {
                    handler() {
                        if (!this._isProcessingLocalChange) this.saveToStorage();
                    },
                    deep: true
                },
                manualHoldings: {
                    handler() {
                        if (!this._isProcessingLocalChange) this.saveToStorage();
                    },
                    deep: true
                },
                targetValue() {
                    if (!this._isProcessingLocalChange) this.saveToStorage();
                },
                targetPercentages: {
                    handler() {
                        if (!this._isProcessingLocalChange) this.saveToStorage();
                    },
                    deep: true
                },
                costBasisOverrides: {
                    handler() {
                        if (!this._isProcessingLocalChange) this.saveToStorage();
                    },
                    deep: true
                },
                targetCashPercentage() {
                    if (!this._isProcessingLocalChange) this.saveToStorage();
                },
                targetReferencePercentage() {
                    if (!this._isProcessingLocalChange) this.saveToStorage();
                },
                visibleColumns: {
                    handler() {
                        if (!this._isProcessingLocalChange) this.saveToStorage();
                    },
                    deep: true
                },
                realisedProfits: {
                    handler() {
                        if (!this._isProcessingLocalChange) this.saveToStorage();
                    },
                    deep: true
                }
            },
            computed: {
                portfolio() {
                    const allHoldings = [
                        ...this.t212Holdings,
                        ...this.ibkrHoldings,
                        ...this.getManualCashHoldings(),
                        ...this.getManualStockHoldings()
                    ];

                    // Group holdings by symbol
                    const grouped = this.groupHoldings(allHoldings);

                    const totalNetWorth = grouped.reduce((sum, h) => sum + h.valueGBP, 0);
                    const cashTotal = grouped.filter(h => h.type === 'cash').reduce((sum, h) => sum + h.valueGBP, 0);
                    const stocksTotal = grouped.filter(h => h.type !== 'cash').reduce((sum, h) => sum + h.valueGBP, 0);

                    // VUSA breakdown
                    const vusaTotal = grouped.filter(h => h.symbol === 'VUSA').reduce((sum, h) => sum + h.valueGBP, 0);
                    const otherStocksTotal = grouped.filter(h => h.type !== 'cash' && h.symbol !== 'VUSA').reduce((sum, h) => sum + h.valueGBP, 0);

                    // Calculate broker-specific totals
                    const t212Total = this.t212Holdings.reduce((sum, h) => sum + h.valueGBP, 0);
                    const t212Cash = this.t212Holdings.filter(h => h.type === 'cash').reduce((sum, h) => sum + h.valueGBP, 0);
                    const t212Stocks = this.t212Holdings.filter(h => h.type !== 'cash').reduce((sum, h) => sum + h.valueGBP, 0);
                    const t212Invested = this.t212Holdings.filter(h => h.type !== 'cash').reduce((sum, h) => sum + (h.costBasisGBP || 0), 0);
                    const t212PL = this.t212Holdings.filter(h => h.type !== 'cash').reduce((sum, h) => sum + (h.unrealizedPL || 0), 0);

                    const ibkrTotal = this.ibkrHoldings.reduce((sum, h) => sum + h.valueGBP, 0);
                    const ibkrCash = this.ibkrHoldings.filter(h => h.type === 'cash').reduce((sum, h) => sum + h.valueGBP, 0);
                    const ibkrStocks = this.ibkrHoldings.filter(h => h.type !== 'cash').reduce((sum, h) => sum + h.valueGBP, 0);
                    const ibkrInvested = this.ibkrHoldings.filter(h => h.type !== 'cash').reduce((sum, h) => sum + (h.costBasisGBP || 0), 0);
                    const ibkrPL = this.ibkrHoldings.filter(h => h.type !== 'cash').reduce((sum, h) => sum + (h.unrealizedPL || 0), 0);

                    const manualTotal = this.getManualCashHoldings().reduce((sum, h) => sum + h.valueGBP, 0);

                    // Calculate realised P/L from holdings (stored in cash entries)
                    const t212RealisedPL = this.t212Holdings.find(h => h.type === 'cash')?.realisedPL || 0;
                    const ibkrRealisedPL = this.ibkrHoldings.find(h => h.type === 'cash')?.realisedPL || 0;

                    // Calculate total P/L (unrealised + realised)
                    const totalUnrealisedPL = t212PL + ibkrPL;
                    const totalRealisedPL = t212RealisedPL + ibkrRealisedPL;
                    const totalPL = totalUnrealisedPL + totalRealisedPL;
                    const totalInvested = t212Invested + ibkrInvested;

                    const holdings = grouped.map(h => ({
                        ...h,
                        percentageOfPortfolio: totalNetWorth > 0 ? (h.valueGBP / totalNetWorth) * 100 : 0
                    }));

                    return {
                        totalNetWorth,
                        cashTotal,
                        cashPercentage: totalNetWorth > 0 ? (cashTotal / totalNetWorth) * 100 : 0,
                        stocksTotal,
                        stocksPercentage: totalNetWorth > 0 ? (stocksTotal / totalNetWorth) * 100 : 0,
                        vusaTotal,
                        vusaPercentage: totalNetWorth > 0 ? (vusaTotal / totalNetWorth) * 100 : 0,
                        otherStocksTotal,
                        otherStocksPercentage: totalNetWorth > 0 ? (otherStocksTotal / totalNetWorth) * 100 : 0,
                        t212Total,
                        t212Cash,
                        t212Stocks,
                        t212Invested,
                        t212PL,
                        t212PLPercent: t212Invested > 0 ? (t212PL / t212Invested) * 100 : 0,
                        t212RealisedPL,
                        t212CashPercentage: t212Total > 0 ? (t212Cash / t212Total) * 100 : 0,
                        t212StocksPercentage: t212Total > 0 ? (t212Stocks / t212Total) * 100 : 0,
                        ibkrTotal,
                        ibkrCash,
                        ibkrStocks,
                        ibkrInvested,
                        ibkrPL,
                        ibkrPLPercent: ibkrInvested > 0 ? (ibkrPL / ibkrInvested) * 100 : 0,
                        ibkrRealisedPL,
                        ibkrCashPercentage: ibkrTotal > 0 ? (ibkrCash / ibkrTotal) * 100 : 0,
                        ibkrStocksPercentage: ibkrTotal > 0 ? (ibkrStocks / ibkrTotal) * 100 : 0,
                        manualTotal,
                        holdings,
                        // Total P/L values
                        totalUnrealisedPL,
                        totalRealisedPL,
                        totalPL,
                        totalInvested,
                        totalPLPercent: totalInvested > 0 ? (totalPL / totalInvested) * 100 : 0
                    };
                },
                // Calculate total target percentage for only existing holdings (excludes deleted stocks)
                existingHoldingsTargetPctTotal() {
                    const holdingSymbols = new Set(
                        this.portfolio.holdings
                            .filter(h => h.type !== 'cash' && h.symbol !== 'VUSA')
                            .map(h => h.symbol)
                    );
                    return Object.entries(this.targetPercentages)
                        .filter(([symbol]) => holdingSymbols.has(symbol))
                        .reduce((sum, [, val]) => sum + (parseFloat(val) || 0), 0);
                },
                sortedHoldings() {
                    // Filter out cash and VUSA
                    const holdings = [...this.portfolio.holdings].filter(h => h.type !== 'cash' && h.symbol !== 'VUSA');

                    // Apply cost basis with priority:
                    // 1. Manual override (costBasisOverrides) - user explicitly edited
                    // 2. Calculated from transactions - combines T212 and IBKR trades
                    // 3. Current broker cost - from latest import (already set)
                    holdings.forEach(h => {
                        const override = this.costBasisOverrides[h.symbol];
                        const calculatedCost = this.calculateCostBasisFromTransactions(h.symbol);

                        if (override !== undefined && override !== null && override !== '') {
                            // Priority 1: Manual override
                            h.costBasisGBP = parseFloat(override);
                            h.usingCalculatedCost = false;
                        } else if (calculatedCost && calculatedCost.costBasisGBP > 0) {
                            // Priority 2: Calculated cost basis from all transactions
                            h.costBasisGBP = calculatedCost.costBasisGBP;
                            h.usingCalculatedCost = true;
                        }
                        // Priority 3: Keep current broker cost (already set)

                        // Recalculate derived values
                        if (h.costBasisGBP > 0 && h.quantity > 0) {
                            h.avgPriceGBP = h.costBasisGBP / h.quantity;
                            // Also update avgPriceNative so the display uses the correct value
                            // (avgPriceNative takes priority in the template)
                            if (h.nativeCurrency && h.nativeCurrency !== 'GBP') {
                                h.avgPriceNative = h.avgPriceGBP * this.gbpUsdRate;
                            } else {
                                h.avgPriceNative = h.avgPriceGBP;
                            }
                            h.unrealizedPL = h.valueGBP - h.costBasisGBP;
                            h.unrealizedPLPercent = (h.unrealizedPL / h.costBasisGBP) * 100;
                        }
                    });

                    // Add computed percentage fields if target value is set
                    if (this.targetValue > 0) {
                        // Use the computed property for total target percentage of existing holdings
                        const totalOriginalTargetPct = this.existingHoldingsTargetPctTotal;

                        // Calculate available percentage for stocks (100% - cash%)
                        const availableForStocks = 100 - (this.targetCashPercentage || 0);

                        holdings.forEach(h => {
                            h.percentInvested = h.costBasisGBP ? (h.costBasisGBP / this.targetValue) * 100 : 0;
                            h.percentCurrent = (h.valueGBP / this.targetValue) * 100;
                            const targetPct = parseFloat(this.targetPercentages[h.symbol]) || 0;
                            h.percentDiff = h.percentInvested - targetPct;

                            // Calculate GBP difference (how much more/less to invest to reach target)
                            const targetAmount = (this.targetValue * targetPct) / 100;
                            h.gbpDiff = targetAmount - (h.costBasisGBP || 0);

                            // Adjusted target calculations (accounting for cash allocation)
                            if (totalOriginalTargetPct > 0) {
                                // Scale the target percentage proportionally
                                h.adjustedTargetPct = (targetPct / totalOriginalTargetPct) * availableForStocks;
                            } else {
                                h.adjustedTargetPct = 0;
                            }

                            // Adjusted diff % (difference from adjusted target)
                            h.adjustedPercentDiff = h.percentInvested - h.adjustedTargetPct;

                            // Adjusted diff Â£ (GBP to reach adjusted target)
                            const adjustedTargetAmount = (this.targetValue * h.adjustedTargetPct) / 100;
                            h.adjustedGbpDiff = adjustedTargetAmount - (h.costBasisGBP || 0);
                        });
                    }

                    return holdings.sort((a, b) => {
                        let aVal = a[this.sortField];
                        let bVal = b[this.sortField];

                        if (typeof aVal === 'string') {
                            aVal = aVal.toLowerCase();
                            bVal = bVal.toLowerCase();
                        }

                        if (this.sortAsc) {
                            return aVal > bVal ? 1 : -1;
                        } else {
                            return aVal < bVal ? 1 : -1;
                        }
                    });
                },
                combinedDebugStocks() {
                    // Combine T212 and IBKR holdings by symbol for debug display
                    const stockMap = {};

                    // Helper to ensure stock entry exists
                    const ensureStock = (symbol) => {
                        if (!stockMap[symbol]) {
                            stockMap[symbol] = {
                                symbol: symbol,
                                totalShares: 0,
                                costBasisGBP: 0,
                                valueGBP: 0,
                                sources: [],
                                transactionCount: 0,
                                t212TxCount: 0,
                                ibkrTxCount: 0
                            };
                        }
                    };

                    // Add T212 stocks from holdings
                    this.t212Holdings.filter(h => h.type !== 'cash').forEach(h => {
                        ensureStock(h.symbol);
                        stockMap[h.symbol].totalShares += h.quantity || 0;
                        stockMap[h.symbol].costBasisGBP += h.costBasisGBP || 0;
                        stockMap[h.symbol].valueGBP += h.valueGBP || 0;
                    });

                    // Add IBKR stocks from holdings
                    this.ibkrHoldings.filter(h => h.type !== 'cash').forEach(h => {
                        ensureStock(h.symbol);
                        stockMap[h.symbol].totalShares += h.quantity || 0;
                        stockMap[h.symbol].costBasisGBP += h.costBasisGBP || 0;
                        stockMap[h.symbol].valueGBP += h.valueGBP || 0;
                    });

                    // Add stocks from T212 transactions (even if no current holdings)
                    (this.t212Transactions || []).forEach(tx => {
                        ensureStock(tx.symbol);
                        stockMap[tx.symbol].t212TxCount++;
                        if (!stockMap[tx.symbol].sources.includes('t212')) {
                            stockMap[tx.symbol].sources.push('t212');
                        }
                    });

                    // Add stocks from IBKR transactions (even if no current holdings)
                    (this.ibkrTransactions || []).forEach(tx => {
                        ensureStock(tx.symbol);
                        stockMap[tx.symbol].ibkrTxCount++;
                        if (!stockMap[tx.symbol].sources.includes('ibkr')) {
                            stockMap[tx.symbol].sources.push('ibkr');
                        }
                    });

                    // Calculate transaction counts and use calculated cost basis
                    Object.keys(stockMap).forEach(symbol => {
                        stockMap[symbol].transactionCount = stockMap[symbol].t212TxCount + stockMap[symbol].ibkrTxCount;

                        // Use calculated cost basis if available
                        const calculated = this.calculateCostBasisFromTransactions(symbol);
                        if (calculated && calculated.costBasisGBP > 0) {
                            stockMap[symbol].costBasisGBP = calculated.costBasisGBP;
                        }
                    });

                    // Convert to array and calculate P/L
                    return Object.values(stockMap).map(stock => {
                        stock.pl = stock.valueGBP - stock.costBasisGBP;
                        stock.plPercent = stock.costBasisGBP > 0 ? (stock.pl / stock.costBasisGBP) * 100 : 0;
                        return stock;
                    }).sort((a, b) => b.valueGBP - a.valueGBP);
                },
                hasData() {
                    return this.t212Holdings.length > 0 ||
                           this.ibkrHoldings.length > 0 ||
                           this.manualCashEntries.some(e => e.label && e.valueGBP > 0);
                }
            },
            methods: {
                // Firebase initialization
                initFirebase() {
                    try {
                        firebase.initializeApp(firebaseConfig);

                        firebase.auth().onAuthStateChanged((user) => {
                            this.user = user;
                            if (user) {
                                this.showAuthModal = false;
                                this.loadFromFirebase();
                            } else {
                                this.showAuthModal = true;
                                this.syncStatus = 'offline';
                                // Unsubscribe from listener when logged out
                                if (this._unsubscribeFirestore) {
                                    this._unsubscribeFirestore();
                                    this._unsubscribeFirestore = null;
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Firebase initialization failed:', error);
                        this.syncError = 'Firebase setup required. Please configure firebase-config.js';
                    }
                },

                async loadFromFirebase() {
                    if (!this.user) return;

                    this.syncStatus = 'syncing';

                    try {
                        // One-time load from Firebase (no real-time listener)
                        const doc = await firebase.firestore()
                            .collection('users')
                            .doc(this.user.uid)
                            .collection('portfolio')
                            .doc('data')
                            .get();

                        if (doc.exists) {
                            this.applyCloudData(doc.data());
                        }
                        this.syncStatus = 'synced';
                        this.syncError = null;
                    } catch (error) {
                        console.error('Firebase load error:', error);
                        this.syncStatus = 'error';
                        this.syncError = 'Load error: ' + error.message;
                    } finally {
                        // Always allow syncing after initial load attempt,
                        // even on failure â€” prevents permanent sync block
                        this._hasLoadedFromCloud = true;
                    }
                },

                // Authentication
                async login() {
                    try {
                        await firebase.auth().signInWithEmailAndPassword(
                            this.authEmail,
                            this.authPassword
                        );
                        this.syncError = null;
                    } catch (error) {
                        this.syncError = 'Login failed: ' + error.message;
                    }
                },

                async signup() {
                    if (this.authPassword.length < 6) {
                        this.syncError = 'Password must be at least 6 characters';
                        return;
                    }
                    try {
                        await firebase.auth().createUserWithEmailAndPassword(
                            this.authEmail,
                            this.authPassword
                        );
                        this.syncError = null;
                    } catch (error) {
                        this.syncError = 'Signup failed: ' + error.message;
                    }
                },

                logout() {
                    if (confirm('Logout? Local data will remain but won\'t sync until you login again.')) {
                        firebase.auth().signOut();
                    }
                },

                // Cloud Sync - Firebase is the single source of truth
                async syncToCloud() {
                    if (!this.user) {
                        this.syncStatus = 'offline';
                        return;
                    }

                    // SAFEGUARD: Don't sync until we've loaded from cloud first
                    // This prevents the initial empty state from overwriting cloud data
                    if (!this._hasLoadedFromCloud) {
                        console.warn('SAFEGUARD: Waiting for initial cloud load before syncing');
                        return;
                    }

                    this.syncStatus = 'syncing';
                    try {
                        const data = {
                            t212Holdings: this.t212Holdings,
                            t212RowCount: this.t212RowCount,
                            t212File: this.t212File ? { name: this.t212File.name } : null,
                            t212Transactions: this.t212Transactions,
                            ibkrHoldings: this.ibkrHoldings,
                            ibkrRowCount: this.ibkrRowCount,
                            ibkrFile: this.ibkrFile ? { name: this.ibkrFile.name } : null,
                            ibkrTransactions: this.ibkrTransactions,
                            manualCashEntries: this.manualCashEntries,
                            manualHoldings: this.manualHoldings,
                            targetValue: this.targetValue,
                            targetPercentages: this.targetPercentages,
                            costBasisOverrides: this.costBasisOverrides,
                            targetCashPercentage: this.targetCashPercentage,
                            targetReferencePercentage: this.targetReferencePercentage,
                            realisedProfits: this.realisedProfits,
                            visibleColumns: this.visibleColumns,
                            gbpUsdRate: this.gbpUsdRate,
                            gbpCadRate: this.gbpCadRate,
                            lastExchangeRateUpdate: this.lastExchangeRateUpdate,
                            timestamp: Date.now()
                        };

                        await firebase.firestore()
                            .collection('users')
                            .doc(this.user.uid)
                            .collection('portfolio')
                            .doc('data')
                            .set(data);

                        this.syncStatus = 'synced';
                        this.lastSyncTime = Date.now();
                        this.syncError = null;
                    } catch (error) {
                        this.syncStatus = 'error';
                        this.syncError = 'Sync failed: ' + error.message;
                        console.error('Sync error:', error);
                    }
                },

                async syncFromCloud() {
                    if (!this.user) {
                        this.syncStatus = 'offline';
                        return;
                    }

                    this.syncStatus = 'syncing';
                    try {
                        const doc = await firebase.firestore()
                            .collection('users')
                            .doc(this.user.uid)
                            .collection('portfolio')
                            .doc('data')
                            .get();

                        if (doc.exists) {
                            this.applyCloudData(doc.data());
                        }

                        this.syncStatus = 'synced';
                        this.syncError = null;
                    } catch (error) {
                        this.syncStatus = 'error';
                        this.syncError = 'Sync failed: ' + error.message;
                        console.error('Sync error:', error);
                    }
                },

                applyCloudData(cloudData) {
                    // Skip if we're in the middle of a local change (prevents race condition)
                    if (this._isProcessingLocalChange) {
                        return;
                    }
                    // Firebase is the single source of truth - always apply cloud data
                    this._hasLoadedFromCloud = true; // Mark that we've received data from cloud
                    this.t212Holdings = cloudData.t212Holdings || [];
                    this.t212RowCount = cloudData.t212RowCount || 0;
                    this.t212File = cloudData.t212File || null;
                    this.t212Transactions = cloudData.t212Transactions || [];
                    this.ibkrHoldings = cloudData.ibkrHoldings || [];
                    this.ibkrRowCount = cloudData.ibkrRowCount || 0;
                    this.ibkrFile = cloudData.ibkrFile || null;
                    this.ibkrTransactions = cloudData.ibkrTransactions || [];
                    this.manualCashEntries = cloudData.manualCashEntries || [];
                    this.manualHoldings = cloudData.manualHoldings || [];
                    this.targetValue = cloudData.targetValue || 0;
                    this.targetPercentages = cloudData.targetPercentages || {};
                    this.costBasisOverrides = cloudData.costBasisOverrides || {};
                    this.targetCashPercentage = cloudData.targetCashPercentage || 0;
                    this.targetReferencePercentage = cloudData.targetReferencePercentage || 5;
                    this.realisedProfits = cloudData.realisedProfits || { t212: 0, ibkr: 0 };
                    this.visibleColumns = cloudData.visibleColumns || {
                        avgPrice: true,
                        currentPrice: true,
                        invested: true,
                        pl: true,
                        plPercent: true,
                        percentInvested: true,
                        targetPercent: true,
                        diffPercent: true,
                        diffGbp: true,
                        adjustedTargetPct: true,
                        adjustedDiffPercent: true,
                        adjustedDiffGbp: true
                    };

                    // Restore exchange rate data
                    if (cloudData.gbpUsdRate) {
                        this.gbpUsdRate = cloudData.gbpUsdRate;
                    }
                    if (cloudData.gbpCadRate) {
                        this.gbpCadRate = cloudData.gbpCadRate;
                    }
                    if (cloudData.lastExchangeRateUpdate) {
                        this.lastExchangeRateUpdate = cloudData.lastExchangeRateUpdate;
                    }

                    // Fetch fresh prices for all holdings after loading from cloud
                    this.refreshPrices();
                },

                async refreshPrices() {
                    const allHoldings = [...this.t212Holdings, ...this.ibkrHoldings, ...this.manualHoldings]
                        .filter(h => h.type !== 'cash');

                    if (allHoldings.length === 0) return;


                    try {
                        const prices = await this.fetchCurrentPrices(allHoldings);

                        // Helper to convert value to GBP
                        const convertToGBP = (value, currency) => {
                            if (currency === 'GBP') return value;
                            if (currency === 'USD') return value / this.gbpUsdRate;
                            if (currency === 'CAD') return value / this.gbpCadRate;
                            if (currency === 'GBX' || currency === 'GBp') return value / 100;
                            if (currency === 'EUR') return value * 0.85; // Fallback EUR rate
                            return value; // Unknown currency, return as-is
                        };

                        // Update T212 holdings with fresh prices
                        this.t212Holdings = this.t212Holdings.map(h => {
                            if (h.type === 'cash') return h;
                            const priceData = prices[h.symbol];
                            if (priceData) {
                                const valueGBP = convertToGBP(h.quantity * priceData.price, priceData.currency);
                                return {
                                    ...h,
                                    valueGBP,
                                    currentPrice: priceData.price,
                                    currentPriceCurrency: priceData.currency,
                                    unrealizedPL: valueGBP - (h.costBasisGBP || 0),
                                    unrealizedPLPercent: h.costBasisGBP ? ((valueGBP - h.costBasisGBP) / h.costBasisGBP) * 100 : 0
                                };
                            }
                            return h;
                        });

                        // Update IBKR holdings with fresh prices
                        this.ibkrHoldings = this.ibkrHoldings.map(h => {
                            if (h.type === 'cash') return h;
                            const priceData = prices[h.symbol];
                            if (priceData) {
                                const valueGBP = convertToGBP(h.quantity * priceData.price, priceData.currency);
                                return {
                                    ...h,
                                    valueGBP,
                                    currentPrice: priceData.price,
                                    currentPriceCurrency: priceData.currency,
                                    unrealizedPL: valueGBP - (h.costBasisGBP || 0),
                                    unrealizedPLPercent: h.costBasisGBP ? ((valueGBP - h.costBasisGBP) / h.costBasisGBP) * 100 : 0
                                };
                            }
                            return h;
                        });

                    } catch (error) {
                        // Silent fail - prices will use cached values
                    }
                },

                debouncedSyncToCloud() {
                    clearTimeout(this._syncTimeout);
                    this._syncTimeout = setTimeout(() => {
                        this.syncToCloud();
                    }, 2000); // Wait 2 seconds after last change
                },

                // PWA Install
                installPWA() {
                    if (this.deferredPrompt) {
                        this.deferredPrompt.prompt();
                        this.deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('PWA installed');
                            }
                            this.deferredPrompt = null;
                            this.showInstallPrompt = false;
                        });
                    }
                },

                // Exchange Rate
                async fetchExchangeRate() {
                    // Check cache validity
                    if (this.lastExchangeRateUpdate) {
                        const cacheAge = Date.now() - this.lastExchangeRateUpdate;
                        if (cacheAge < this.exchangeRateCacheExpiry) {
                            return; // Use cached rate
                        }
                    }

                    this.exchangeRateLoading = true;
                    this.exchangeRateError = null;

                    try {
                        const response = await fetch('https://api.exchangerate-api.com/v4/latest/GBP');

                        if (!response.ok) {
                            throw new Error('Failed to fetch exchange rate');
                        }

                        const data = await response.json();
                        const usdRate = data.rates.USD;
                        const cadRate = data.rates.CAD;

                        if (!usdRate || typeof usdRate !== 'number') {
                            throw new Error('Invalid exchange rate data');
                        }

                        this.gbpUsdRate = usdRate;
                        if (cadRate && typeof cadRate === 'number') {
                            this.gbpCadRate = cadRate;
                        }
                        this.lastExchangeRateUpdate = Date.now();
                        this.saveToStorage(); // Sync rate to Firebase


                    } catch (error) {
                        console.error('Exchange rate fetch error:', error);
                        this.exchangeRateError = 'Unable to fetch USD exchange rate. Using cached/default rate.';
                        // Keep using existing rate (default or cached)
                    } finally {
                        this.exchangeRateLoading = false;
                    }
                },

                refreshExchangeRate() {
                    // Force refresh by clearing cache timestamp
                    this.lastExchangeRateUpdate = null;
                    this.exchangeRateError = null;
                    this.fetchExchangeRate();
                },

                // Map T212 symbols to Yahoo Finance format
                getYahooSymbol(symbol, isin) {
                    // Manual overrides for known problematic symbols
                    const symbolOverrides = {
                        'SRUUF': 'SRUUF',      // OTC - works as-is on Yahoo
                        'UUUU': 'UUUU',        // NYSE American
                        'UROY': 'UROY',        // NASDAQ - Uranium Royalty Corp
                        'ERO': 'ERO.TO',       // TSX - Ero Copper
                        'NICU': 'NICU.V',      // TSX Venture
                        '7CD': '7CD.F',        // Frankfurt Stock Exchange
                        'AVIO': 'AVIO.MI',     // Milan Stock Exchange
                        'NNND': 'NNND.F',      // Frankfurt Stock Exchange
                        'BOLSY': 'BOLSY',      // ADR - works as-is
                        'ASPI': 'ASPI',        // Works as-is
                        'SKYT': 'SKYT',        // Works as-is
                        'JMIA': 'JMIA',        // NYSE
                        'GGAL': 'GGAL',        // NYSE ADR
                        'KSPI': 'KSPI',        // NYSE
                        'STNE': 'STNE',        // NASDAQ
                        'XPEV': 'XPEV',        // NYSE
                        'JBHT': 'JBHT',        // NASDAQ
                    };

                    if (symbolOverrides[symbol]) {
                        return symbolOverrides[symbol];
                    }

                    // UK/Ireland ETFs (ISIN starting with IE or GB, or known UK tickers)
                    const ukSymbols = ['VUSA', 'IBZL', 'ETN'];
                    if (ukSymbols.includes(symbol) || (isin && (isin.startsWith('IE') || isin.startsWith('GB')))) {
                        // Check if it's already got a suffix
                        if (!symbol.includes('.')) {
                            return symbol + '.L';
                        }
                    }
                    // Canadian stocks on TSX
                    if (isin && isin.startsWith('CA')) {
                        if (!symbol.includes('.')) {
                            // Try TSX first, could also be TSX Venture (.V)
                            return symbol + '.TO';
                        }
                    }
                    // German stocks
                    if (isin && isin.startsWith('DE')) {
                        if (!symbol.includes('.')) {
                            return symbol + '.DE';
                        }
                    }
                    // Italian stocks
                    if (isin && isin.startsWith('IT')) {
                        if (!symbol.includes('.')) {
                            return symbol + '.MI';
                        }
                    }
                    // French stocks
                    if (isin && isin.startsWith('FR')) {
                        if (!symbol.includes('.')) {
                            return symbol + '.PA';
                        }
                    }
                    return symbol;
                },

                // Fetch current stock prices from Yahoo Finance
                async fetchCurrentPrices(holdings) {
                    const prices = {};
                    const batchSize = 3; // Smaller batches for reliability

                    // Build symbol mapping
                    const symbolMap = {};
                    holdings.forEach(h => {
                        if (h.type !== 'cash' && h.symbol) {
                            const yahooSymbol = this.getYahooSymbol(h.symbol, h.isin);
                            symbolMap[yahooSymbol] = h.symbol;
                        }
                    });

                    const yahooSymbols = Object.keys(symbolMap);

                    for (let i = 0; i < yahooSymbols.length; i += batchSize) {
                        const batch = yahooSymbols.slice(i, i + batchSize);
                        const promises = batch.map(async (yahooSymbol) => {
                            const originalSymbol = symbolMap[yahooSymbol];
                            try {
                                // Use Firebase Cloud Function to fetch prices
                                const proxyUrl = `https://us-central1-portfolio-aggregator-fb32a.cloudfunctions.net/getStockPrice?symbol=${encodeURIComponent(yahooSymbol)}`;

                                const response = await fetch(proxyUrl);

                                if (!response.ok) {
                                    console.warn(`Failed to fetch ${yahooSymbol}: ${response.status}`);
                                    return null;
                                }

                                const data = await response.json();

                                // Cloud Function now returns filtered response directly
                                if (data?.regularMarketPrice) {
                                    return {
                                        symbol: originalSymbol,
                                        price: data.regularMarketPrice,
                                        currency: data.currency || 'USD'
                                    };
                                }
                            } catch (e) {
                                console.warn(`Failed to fetch price for ${yahooSymbol}:`, e.message);
                            }
                            return null;
                        });

                        const results = await Promise.all(promises);
                        results.forEach(r => {
                            if (r) prices[r.symbol] = r;
                        });

                        // Delay between batches to avoid rate limiting
                        if (i + batchSize < yahooSymbols.length) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }

                    return prices;
                },

                // Update T212 holdings with current prices
                async updateT212HoldingsWithCurrentPrices(holdings) {
                    const stockHoldings = holdings.filter(h => h.type !== 'cash' && h.symbol);
                    if (stockHoldings.length === 0) return holdings;

                    const prices = await this.fetchCurrentPrices(stockHoldings);

                    return holdings.map(holding => {
                        if (holding.type === 'cash') return holding;

                        const priceData = prices[holding.symbol];
                        if (priceData) {
                            // Calculate value in native currency then convert to GBP
                            let valueGBP = holding.quantity * priceData.price;

                            // Convert to GBP if price is in different currency
                            if (priceData.currency !== 'GBP') {
                                if (priceData.currency === 'USD') {
                                    valueGBP = valueGBP / this.gbpUsdRate;
                                } else if (priceData.currency === 'CAD') {
                                    valueGBP = valueGBP / this.gbpCadRate;
                                } else if (priceData.currency === 'GBX' || priceData.currency === 'GBp') {
                                    // GBX is pence, convert to pounds
                                    valueGBP = valueGBP / 100;
                                }
                                // For other currencies, keep as-is
                            }

                            // Recalculate P/L with correct current value
                            const unrealizedPL = valueGBP - (holding.costBasisGBP || 0);
                            const unrealizedPLPercent = holding.costBasisGBP > 0
                                ? (unrealizedPL / holding.costBasisGBP) * 100
                                : 0;

                            // Update debug log if exists
                            const debugEntry = this.t212DebugLog.find(d => d.symbol === holding.symbol);
                            if (debugEntry) {
                                debugEntry.currentPrice = priceData.price;
                                debugEntry.valueGBP = valueGBP;
                                debugEntry.pl = unrealizedPL;
                                debugEntry.plPercent = holding.costBasisGBP > 0 ? (unrealizedPL / holding.costBasisGBP) * 100 : 0;
                            }

                            return {
                                ...holding,
                                valueGBP,
                                currentPrice: priceData.price,
                                currentPriceCurrency: priceData.currency,
                                unrealizedPL,
                                unrealizedPLPercent,
                                priceUpdated: true
                            };
                        }

                        return holding;
                    });
                },

                // Refresh prices for all holdings
                async refreshAllPrices() {
                    if (this.pricesLoading) return;

                    this.pricesLoading = true;
                    try {
                        // Refresh T212 holdings
                        if (this.t212Holdings.length > 0) {
                            const stockHoldings = this.t212Holdings.filter(h => h.type !== 'cash');
                            if (stockHoldings.length > 0) {
                                this.t212Holdings = await this.updateT212HoldingsWithCurrentPrices(this.t212Holdings);
                            }
                        }

                        this.lastPriceUpdate = Date.now();
                        this.saveToStorage();
                    } catch (error) {
                        // Silent fail on price refresh
                    } finally {
                        this.pricesLoading = false;
                    }
                },

                // File upload handlers
                handleT212Drop(event) {
                    this.t212Dragging = false;
                    const file = event.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) {
                        this.processT212File(file);
                    } else {
                        this.t212Error = 'Please drop a CSV file';
                    }
                },

                handleIBKRDrop(event) {
                    this.ibkrDragging = false;
                    const file = event.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) {
                        this.processIBKRFile(file);
                    } else {
                        this.ibkrError = 'Please drop a CSV file';
                    }
                },

                handleT212Upload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    this.processT212File(file);
                },

                processT212File(file) {
                    this._isProcessingLocalChange = true;
                    this.t212File = file;
                    this.t212Error = null;
                    this.t212Loading = true;

                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: async (results) => {
                            try {
                                // Check if this is transaction history format (has "action" column)
                                const headers = Object.keys(results.data[0] || {});
                                const hasActionCol = headers.some(h =>
                                    h.toLowerCase().includes('action')
                                );

                                let parsed = this.parseT212CSV(results.data);
                                let holdingsArray = parsed.holdings;
                                const transactions = parsed.transactions;

                                // If transaction history format, fetch current prices
                                if (hasActionCol) {
                                    try {
                                        holdingsArray = await this.updateT212HoldingsWithCurrentPrices(holdingsArray);
                                        this.lastPriceUpdate = Date.now();
                                    } catch (priceError) {
                                        console.warn('Failed to fetch current prices:', priceError);
                                        // Continue with calculated values from transactions
                                    }
                                }

                                this.t212Holdings = holdingsArray;
                                this.t212Transactions = transactions;
                                this.t212RowCount = holdingsArray.length;

                                // Sync immediately to Firebase
                                this.syncToCloud().then(() => {
                                    this._isProcessingLocalChange = false;
                                });
                            } catch (error) {
                                this.t212Error = error.message;
                                this.t212Holdings = [];
                                this.t212RowCount = 0;
                                this._isProcessingLocalChange = false;
                            } finally {
                                this.t212Loading = false;
                            }
                        },
                        error: (error) => {
                            this.t212Error = 'Failed to parse CSV: ' + error.message;
                            this.t212Loading = false;
                        }
                    });
                },

                handleIBKRUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    this.processIBKRFile(file);
                },

                processIBKRFile(file) {
                    this._isProcessingLocalChange = true;
                    this.ibkrFile = file;
                    this.ibkrError = null;

                    // First, parse with headers to check if it's an Activity Statement
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        preview: 10,
                        complete: (previewResults) => {
                            const isActivityStatement = previewResults.data.some(row => {
                                const firstCol = Object.keys(row)[0];
                                const value = String(row[firstCol] || '');
                                return value.includes('Statement') || value.includes('Open Positions');
                            });

                            // If Activity Statement, re-parse without headers
                            if (isActivityStatement) {
                                Papa.parse(file, {
                                    header: false,
                                    skipEmptyLines: true,
                                    complete: (results) => {
                                        try {
                                            const parsed = this.parseIBKRActivityStatementRaw(results.data);
                                            this.ibkrHoldings = parsed.holdings;
                                            this.ibkrTransactions = parsed.transactions;
                                            this.ibkrRowCount = this.ibkrHoldings.length;

                                            // Sync immediately to Firebase
                                            this.syncToCloud().then(() => {
                                                this._isProcessingLocalChange = false;
                                            });
                                        } catch (error) {
                                            console.error('IBKR parse error:', error);
                                            this.ibkrError = error.message;
                                            this.ibkrHoldings = [];
                                            this.ibkrRowCount = 0;
                                            this._isProcessingLocalChange = false;
                                        }
                                    },
                                    error: (error) => {
                                        console.error('Papa parse error:', error);
                                        this.ibkrError = 'Failed to parse CSV: ' + error.message;
                                    }
                                });
                            } else {
                                // Use regular parser with headers
                                Papa.parse(file, {
                                    header: true,
                                    skipEmptyLines: true,
                                    complete: (results) => {
                                        try {
                                            const parsed = this.parseIBKRCSV(results.data);
                                            this.ibkrHoldings = parsed.holdings;
                                            this.ibkrTransactions = parsed.transactions;
                                            this.ibkrRowCount = this.ibkrHoldings.length;

                                            // Sync immediately to Firebase
                                            this.syncToCloud().then(() => {
                                                this._isProcessingLocalChange = false;
                                            });
                                        } catch (error) {
                                            this.ibkrError = error.message;
                                            this.ibkrHoldings = [];
                                            this.ibkrRowCount = 0;
                                            this._isProcessingLocalChange = false;
                                        }
                                    },
                                    error: (error) => {
                                        this.ibkrError = 'Failed to parse CSV: ' + error.message;
                                    }
                                });
                            }
                        }
                    });
                },

                clearT212() {
                    this.t212File = null;
                    this.t212Holdings = [];
                    this.t212RowCount = 0;
                    this.t212Transactions = [];
                    this.t212Error = null;
                    if (this.$refs.t212Input) {
                        this.$refs.t212Input.value = '';
                    }
                    this.syncToCloud();
                },

                clearIBKR() {
                    this.ibkrFile = null;
                    this.ibkrHoldings = [];
                    this.ibkrRowCount = 0;
                    this.ibkrTransactions = [];
                    this.ibkrError = null;
                    if (this.$refs.ibkrInput) {
                        this.$refs.ibkrInput.value = '';
                    }
                    this.syncToCloud();
                },

                // CSV Parsers
                parseT212CSV(data) {
                    if (data.length === 0) {
                        throw new Error('CSV file is empty');
                    }

                    const headers = Object.keys(data[0]);

                    // Check if this is transaction history format (has "Action" column)
                    const actionCol = this.findColumn(headers, ['action']);

                    if (actionCol) {
                        // Parse transaction history format
                        return this.parseT212TransactionHistory(data, headers);
                    } else {
                        // Parse portfolio statement format (original parser)
                        return this.parseT212PortfolioStatement(data, headers);
                    }
                },

                parseT212PortfolioStatement(data, headers) {
                    const holdings = [];

                    // Fuzzy match column names
                    const tickerCol = this.findColumn(headers, ['ticker', 'symbol']);
                    const nameCol = this.findColumn(headers, ['name', 'description']);
                    const quantityCol = this.findColumn(headers, ['quantity', 'no. of shares']);
                    const valueCol = this.findColumn(headers, ['value', 'total']);

                    if (!tickerCol || !valueCol) {
                        throw new Error(`Expected columns not found. Looking for: Ticker/Symbol and Value. Found: ${headers.join(', ')}`);
                    }

                    for (const row of data) {
                        const symbol = row[tickerCol]?.trim();
                        const valueStr = row[valueCol]?.toString().replace(/,/g, '');
                        const value = parseFloat(valueStr);

                        if (!symbol || isNaN(value) || value === 0) continue;

                        const name = row[nameCol] || symbol;
                        const quantity = row[quantityCol] ? parseFloat(row[quantityCol].toString().replace(/,/g, '')) : 0;

                        // Determine type
                        let type = 'stock';
                        if (symbol === 'GBP' || symbol.toLowerCase().includes('cash')) {
                            type = 'cash';
                        } else if (name.toLowerCase().includes('etf') || symbol.toLowerCase().includes('etf')) {
                            type = 'etf';
                        }

                        holdings.push({
                            symbol,
                            name,
                            quantity,
                            valueGBP: value,
                            type,
                            source: 't212'
                        });
                    }

                    return { holdings, transactions: [] };
                },

                parseT212TransactionHistory(data, headers) {
                    const positions = {}; // Track positions by ticker
                    let cashBalance = 0; // Track actual cash movements
                    let totalRealisedPL = 0; // Track realised profits from closed positions
                    const allTransactions = []; // Store all buy/sell transactions for cost basis

                    // Find relevant columns
                    const actionCol = this.findColumn(headers, ['action']);
                    const isinCol = this.findColumn(headers, ['isin']);
                    const tickerCol = this.findColumn(headers, ['ticker', 'symbol']);
                    const nameCol = this.findColumn(headers, ['name']);
                    const sharesCol = this.findColumn(headers, ['no. of shares', 'quantity']);
                    const priceCol = this.findColumn(headers, ['price / share', 'price']);
                    const currencyPriceCol = this.findColumn(headers, ['currency (price / share)']);
                    const exchangeRateCol = this.findColumn(headers, ['exchange rate']);
                    const totalCol = this.findColumn(headers, ['total']);
                    const currencyTotalCol = this.findColumn(headers, ['currency (total)']);
                    const feeCol = this.findColumn(headers, ['currency conversion fee']);

                    for (const row of data) {
                        const action = row[actionCol]?.trim();
                        const isin = row[isinCol]?.trim();
                        const ticker = row[tickerCol]?.trim();
                        const name = row[nameCol]?.trim();
                        const shares = parseFloat(row[sharesCol]?.toString().replace(/,/g, '')) || 0;
                        const price = parseFloat(row[priceCol]?.toString().replace(/,/g, '')) || 0;
                        const priceCurrency = row[currencyPriceCol]?.trim() || 'GBP';
                        const exchangeRate = parseFloat(row[exchangeRateCol]?.toString().replace(/,/g, '')) || 1;
                        const total = parseFloat(row[totalCol]?.toString().replace(/,/g, '')) || 0;
                        const totalCurrency = row[currencyTotalCol]?.trim() || 'GBP';
                        const fee = parseFloat(row[feeCol]?.toString().replace(/,/g, '')) || 0;

                        const actionLower = action?.toLowerCase() || '';

                        // Handle cash movements
                        if (actionLower === 'deposit' && totalCurrency === 'GBP') {
                            cashBalance += total;
                            continue;
                        } else if (actionLower === 'withdrawal' && totalCurrency === 'GBP') {
                            cashBalance -= total;
                            continue;
                        } else if (actionLower.includes('dividend')) {
                            // Dividends add to cash (after withholding tax which is already deducted from total)
                            if (totalCurrency === 'GBP') {
                                cashBalance += total;
                            }
                            continue; // Don't process as position change
                        } else if (actionLower.includes('adr fee') || actionLower.includes('custody fee')) {
                            // Fees subtract from cash (total is usually negative, so we add it)
                            if (totalCurrency === 'GBP') {
                                cashBalance += total; // total is negative for fees
                            }
                            continue;
                        } else if (actionLower.includes('stock distribution') || actionLower.includes('stock split')) {
                            // Stock distributions don't affect cash, skip cash handling
                            // but still process as position change below
                        }

                        if (!ticker || !shares) continue;

                        // Track cash for buy/sell transactions (NOT transfers - they don't affect cash)
                        if (actionLower.includes('buy') && !actionLower.includes('transfer')) {
                            // Buying reduces cash (total + fees)
                            if (totalCurrency === 'GBP') {
                                cashBalance -= (total + fee);
                            }
                        } else if (actionLower.includes('sell') && !actionLower.includes('transfer')) {
                            // Selling increases cash (total - fees)
                            if (totalCurrency === 'GBP') {
                                cashBalance += (total - fee);
                            }
                        }

                        // Initialize position for this ticker
                        if (!positions[ticker]) {
                            positions[ticker] = {
                                ticker,
                                name,
                                isin,
                                totalShares: 0,
                                totalCostGBP: 0,       // Total amount invested in GBP
                                totalCostNative: 0,    // Total amount in original currency (for avg price calc)
                                nativeCurrency: priceCurrency || 'USD',
                                totalSharesBought: 0,   // Total shares ever bought
                                lastPrice: 0,
                                lastPriceCurrency: 'GBP',
                                lastExchangeRate: 1,
                                transactions: []       // Track all transactions for debugging
                            };
                        } else if (isin && !positions[ticker].isin) {
                            // Update ISIN if we have it now but didn't before
                            positions[ticker].isin = isin;
                        }

                        // Log transaction for debugging
                        positions[ticker].transactions.push({
                            action,
                            shares,
                            price,
                            currency: priceCurrency,
                            total,
                            totalCurrency,
                            fee,
                            exchangeRate
                        });

                        // Update position based on action (actionLower already declared above)
                        if (actionLower.includes('buy') || actionLower.includes('transfer in')) {
                            // Buy or transfer in = add shares
                            positions[ticker].totalShares += shares;
                            positions[ticker].totalSharesBought += shares;

                            // Calculate cost in GBP
                            let costGBP;
                            if (totalCurrency === 'GBP') {
                                costGBP = total + fee;
                            } else {
                                costGBP = (total + fee) / exchangeRate;
                            }
                            positions[ticker].totalCostGBP += costGBP;

                            // Track native currency cost for accurate avg price (price * shares, not total which includes fees)
                            positions[ticker].totalCostNative += (price * shares);

                            positions[ticker].lastPrice = price;
                            positions[ticker].lastPriceCurrency = priceCurrency;
                            positions[ticker].lastExchangeRate = exchangeRate;
                            positions[ticker].name = name; // Update name

                            // Record transaction for cost basis calculation (only actual buys, not transfers)
                            if (actionLower.includes('buy') && !actionLower.includes('transfer')) {
                                allTransactions.push({
                                    type: 'buy',
                                    symbol: ticker,
                                    shares: shares,
                                    costGBP: costGBP,
                                    date: row[this.findColumn(headers, ['time'])] || null,
                                    source: 't212'
                                });
                            }
                        } else if (actionLower.includes('sell') || actionLower.includes('transfer out')) {
                            // Sell or transfer out = remove shares
                            // Use average cost method to reduce cost basis proportionally
                            const avgCostGBP = positions[ticker].totalShares > 0
                                ? positions[ticker].totalCostGBP / positions[ticker].totalShares
                                : 0;
                            const avgCostNative = positions[ticker].totalShares > 0
                                ? positions[ticker].totalCostNative / positions[ticker].totalShares
                                : 0;
                            const costToRemove = avgCostGBP * shares;

                            // Calculate realised profit for sells (not transfers)
                            if (actionLower.includes('sell') && !actionLower.includes('transfer') && totalCurrency === 'GBP') {
                                const saleProceeds = total - fee; // Net proceeds after fees
                                const realisedPL = saleProceeds - costToRemove;
                                totalRealisedPL += realisedPL;
                            }

                            positions[ticker].totalShares -= shares;
                            positions[ticker].totalCostGBP -= costToRemove;
                            positions[ticker].totalCostNative -= avgCostNative * shares;

                            // Still update last price to most recent
                            positions[ticker].lastPrice = price;
                            positions[ticker].lastPriceCurrency = priceCurrency;
                            positions[ticker].lastExchangeRate = exchangeRate;

                            // Record transaction for cost basis calculation (only actual sells, not transfers)
                            if (actionLower.includes('sell') && !actionLower.includes('transfer')) {
                                allTransactions.push({
                                    type: 'sell',
                                    symbol: ticker,
                                    shares: shares,
                                    proceedsGBP: totalCurrency === 'GBP' ? total : total / exchangeRate,
                                    date: row[this.findColumn(headers, ['time'])] || null,
                                    source: 't212'
                                });
                            }
                        } else if (actionLower.includes('stock split') || actionLower.includes('stock distribution')) {
                            // Trading 212 handles splits as two transactions:
                            // 1. "Stock split close" - removes old shares
                            // 2. "Stock split open" - adds new split shares
                            // Cost basis should NOT change for either - just the share count

                            if (actionLower.includes('close')) {
                                // Stock split close: remove old shares, but keep cost basis
                                positions[ticker].totalShares -= shares;
                                // Do NOT reduce totalCostGBP or totalCostNative
                            } else {
                                // Stock split open (or generic split): add new shares
                                positions[ticker].totalShares += shares;
                                // Do NOT add to totalCostGBP or totalCostNative
                            }

                            // Update last price if provided (usually adjusted post-split price)
                            if (price > 0) {
                                positions[ticker].lastPrice = price;
                                positions[ticker].lastPriceCurrency = priceCurrency;
                                positions[ticker].lastExchangeRate = exchangeRate;
                            }
                        }
                    }

                    // Convert positions to holdings array
                    const holdings = [];

                    // Add stock/ETF positions
                    for (const ticker in positions) {
                        const pos = positions[ticker];

                        // Skip if position is closed (no shares)
                        if (pos.totalShares <= 0.0001) continue;

                        // Calculate value in GBP
                        let valueGBP;
                        if (pos.lastPriceCurrency === 'GBP') {
                            // Already in GBP
                            valueGBP = pos.totalShares * pos.lastPrice;
                        } else {
                            // Convert from foreign currency (USD, CAD, EUR, GBX, etc.)
                            // Exchange rate is foreign currency per GBP (e.g., 1.84 CAD/GBP)
                            valueGBP = (pos.totalShares * pos.lastPrice) / pos.lastExchangeRate;
                        }

                        // Determine type
                        let type = 'stock';
                        if (pos.name && (pos.name.toLowerCase().includes('etf') || pos.name.toLowerCase().includes('vanguard'))) {
                            type = 'etf';
                        }

                        // Calculate P/L metrics
                        const costBasisGBP = pos.totalCostGBP;
                        const avgPriceGBP = costBasisGBP / pos.totalShares;
                        const avgPriceNative = pos.totalCostNative / pos.totalShares;
                        const unrealizedPL = valueGBP - costBasisGBP;
                        const unrealizedPLPercent = costBasisGBP > 0 ? (unrealizedPL / costBasisGBP) * 100 : 0;

                        holdings.push({
                            symbol: ticker,
                            name: pos.name || ticker,
                            isin: pos.isin,
                            quantity: pos.totalShares,
                            valueGBP: valueGBP,
                            costBasisGBP: costBasisGBP,
                            avgPriceGBP: avgPriceGBP,
                            avgPriceNative: avgPriceNative,
                            nativeCurrency: pos.nativeCurrency,
                            unrealizedPL: unrealizedPL,
                            unrealizedPLPercent: unrealizedPLPercent,
                            type,
                            source: 't212'
                        });
                    }

                    // Add cash balance (show even if small/negative for debugging)
                    // Note: Negative cash means you've spent more than deposited (due to losses)
                    console.log('T212 Realised P/L:', totalRealisedPL.toFixed(2));
                    holdings.push({
                        symbol: 'GBP',
                        name: cashBalance >= 0 ? 'Cash' : 'Cash (deficit)',
                        quantity: 1,
                        valueGBP: cashBalance,
                        type: 'cash',
                        source: 't212',
                        realisedPL: totalRealisedPL // Include realised P/L from all closed positions
                    });

                    // Build debug log for each position
                    this.t212DebugLog = [];
                    for (const ticker in positions) {
                        const pos = positions[ticker];
                        if (pos.totalShares <= 0.0001) continue;

                        const avgPriceNative = pos.totalCostNative / pos.totalShares;
                        let valueGBP;
                        if (pos.lastPriceCurrency === 'GBP') {
                            valueGBP = pos.totalShares * pos.lastPrice;
                        } else {
                            valueGBP = (pos.totalShares * pos.lastPrice) / pos.lastExchangeRate;
                        }

                        this.t212DebugLog.push({
                            symbol: ticker,
                            currency: pos.nativeCurrency,
                            totalShares: pos.totalShares,
                            avgPriceNative: avgPriceNative,
                            currentPrice: pos.lastPrice,
                            costBasisGBP: pos.totalCostGBP,
                            valueGBP: valueGBP,
                            pl: valueGBP - pos.totalCostGBP,
                            plPercent: pos.totalCostGBP > 0 ? ((valueGBP - pos.totalCostGBP) / pos.totalCostGBP) * 100 : 0,
                            transactions: pos.transactions || []
                        });
                    }

                    return { holdings, transactions: allTransactions };
                },

                parseIBKRCSV(data) {
                    if (data.length === 0) {
                        throw new Error('CSV file is empty');
                    }

                    const headers = Object.keys(data[0]);

                    // Check if this is an Activity Statement format
                    // Activity Statements have section names in the first column
                    // Note: First column might have BOM character (ï»¿Statement)
                    const firstRow = data[0];
                    const firstCol = headers[0];
                    const firstValue = String(firstRow[firstCol] || '').trim();

                    // Check first few rows for section names (handle BOM and various formats)
                    let isActivityStatement = false;
                    for (let i = 0; i < Math.min(10, data.length); i++) {
                        const rowValue = String(data[i][firstCol] || '');
                        if (rowValue.includes('Statement') ||
                            rowValue.includes('Account Information') ||
                            rowValue.includes('Open Positions') ||
                            rowValue.includes('Cash Report') ||
                            rowValue.includes('Net Asset Value')) {
                            isActivityStatement = true;
                            break;
                        }
                    }

                    if (isActivityStatement) {
                        // This is an Activity Statement - use specialized parser
                        return this.parseIBKRActivityStatement(data);
                    }

                    // Check if this is a T212-like transaction history format (has "Action" column)
                    const actionCol = this.findColumn(headers, ['action']);
                    if (actionCol) {
                        // Parse as T212-like transaction history format
                        return this.parseIBKRTransactionHistory(data, headers);
                    }

                    // Otherwise, use the original simple parser
                    const holdings = [];

                    // Fuzzy match column names
                    const symbolCol = this.findColumn(headers, ['symbol', 'ticker']);
                    const descCol = this.findColumn(headers, ['description', 'name']);
                    const quantityCol = this.findColumn(headers, ['quantity', 'position']);
                    const valueCol = this.findColumn(headers, ['value', 'position value', 'market value']);

                    if (!symbolCol || !valueCol) {
                        throw new Error(`Expected columns not found. Looking for: Symbol and Value. Found: ${headers.join(', ')}`);
                    }

                    for (const row of data) {
                        const symbol = row[symbolCol]?.trim();
                        const valueStr = row[valueCol]?.toString().replace(/,/g, '');
                        const value = parseFloat(valueStr);

                        if (!symbol || isNaN(value) || value === 0) continue;

                        // Skip summary rows
                        if (symbol.includes('Total') || symbol.includes('TOTAL')) continue;

                        const name = row[descCol] || symbol;
                        const quantity = row[quantityCol] ? parseFloat(row[quantityCol].toString().replace(/,/g, '')) : 0;

                        // Determine type
                        let type = 'stock';
                        if (symbol === 'GBP' || symbol === 'USD' || symbol.includes('BASE_SUMMARY')) {
                            type = 'cash';
                        } else if (name.toLowerCase().includes('etf') || symbol.toLowerCase().includes('etf')) {
                            type = 'etf';
                        }

                        holdings.push({
                            symbol: symbol === 'BASE_SUMMARY' ? 'GBP' : symbol,
                            name: type === 'cash' ? 'Cash' : name,
                            quantity,
                            valueGBP: Math.abs(value), // Use absolute value
                            type,
                            source: 'ibkr'
                        });
                    }

                    return { holdings, transactions: [] };
                },

                // Parse IBKR export in T212-like transaction history format
                parseIBKRTransactionHistory(data, headers) {
                    const positions = {}; // Track positions by ticker
                    let cashBalance = 0;
                    const allTransactions = [];

                    // Find relevant columns (same as T212 format)
                    const actionCol = this.findColumn(headers, ['action']);
                    const tickerCol = this.findColumn(headers, ['ticker', 'symbol']);
                    const nameCol = this.findColumn(headers, ['name']);
                    const sharesCol = this.findColumn(headers, ['no. of shares', 'quantity']);
                    const priceCol = this.findColumn(headers, ['price / share', 'price']);
                    const currencyPriceCol = this.findColumn(headers, ['currency (price / share)']);
                    const exchangeRateCol = this.findColumn(headers, ['exchange rate']);
                    const totalCol = this.findColumn(headers, ['total']);
                    const currencyTotalCol = this.findColumn(headers, ['currency (total)']);
                    const timeCol = this.findColumn(headers, ['time']);

                    for (const row of data) {
                        const action = row[actionCol]?.trim();
                        const ticker = row[tickerCol]?.trim();
                        const name = row[nameCol]?.trim();

                        if (!action) continue;

                        const sharesRaw = row[sharesCol]?.toString().replace(/,/g, '');
                        const shares = parseFloat(sharesRaw) || 0;
                        const priceRaw = row[priceCol]?.toString().replace(/,/g, '');
                        const pricePerShare = parseFloat(priceRaw) || 0;
                        const priceCurrency = row[currencyPriceCol]?.trim() || 'GBP';
                        const exchangeRate = parseFloat(row[exchangeRateCol]) || 1;
                        const totalRaw = row[totalCol]?.toString().replace(/,/g, '');
                        const total = parseFloat(totalRaw) || 0;
                        const totalCurrency = row[currencyTotalCol]?.trim() || 'GBP';
                        const dateTime = row[timeCol]?.trim() || '';

                        // Handle different action types
                        if (action.includes('Limit buy') || action.includes('Market buy') || action === 'Buy') {
                            if (!ticker || shares === 0) continue;

                            // Convert to GBP
                            const costGBP = totalCurrency === 'GBP' ? Math.abs(total) :
                                (priceCurrency === 'GBP' ? shares * pricePerShare : shares * pricePerShare / exchangeRate);

                            if (!positions[ticker]) {
                                positions[ticker] = {
                                    symbol: ticker,
                                    name: name || ticker,
                                    totalShares: 0,
                                    totalCostGBP: 0,
                                    currency: priceCurrency,
                                    source: 'ibkr'
                                };
                            }

                            positions[ticker].totalShares += shares;
                            positions[ticker].totalCostGBP += costGBP;

                            allTransactions.push({
                                type: 'buy',
                                symbol: ticker,
                                shares: shares,
                                costGBP: costGBP,
                                pricePerShare: pricePerShare,
                                currency: priceCurrency,
                                date: dateTime,
                                source: 'ibkr'
                            });
                        } else if (action.includes('Limit sell') || action.includes('Market sell') || action === 'Sell') {
                            if (!ticker || shares === 0) continue;

                            // Convert to GBP
                            const proceedsGBP = totalCurrency === 'GBP' ? Math.abs(total) :
                                (priceCurrency === 'GBP' ? shares * pricePerShare : shares * pricePerShare / exchangeRate);

                            if (positions[ticker]) {
                                // Average cost method for reducing position
                                const avgCostPerShare = positions[ticker].totalShares > 0 ?
                                    positions[ticker].totalCostGBP / positions[ticker].totalShares : 0;
                                const costReduction = avgCostPerShare * shares;

                                positions[ticker].totalShares -= shares;
                                positions[ticker].totalCostGBP -= costReduction;

                                if (positions[ticker].totalShares < 0.0001) {
                                    positions[ticker].totalShares = 0;
                                    positions[ticker].totalCostGBP = 0;
                                }
                            }

                            allTransactions.push({
                                type: 'sell',
                                symbol: ticker,
                                shares: shares,
                                proceedsGBP: proceedsGBP,
                                pricePerShare: pricePerShare,
                                currency: priceCurrency,
                                date: dateTime,
                                source: 'ibkr'
                            });
                        } else if (action === 'Deposit' || action === 'Withdrawal') {
                            const amount = totalCurrency === 'GBP' ? total : total / exchangeRate;
                            if (action === 'Deposit') {
                                cashBalance += Math.abs(amount);
                            } else {
                                cashBalance -= Math.abs(amount);
                            }
                        }
                    }

                    // Convert positions to holdings
                    const holdings = Object.values(positions)
                        .filter(p => p.totalShares > 0.0001)
                        .map(p => ({
                            symbol: p.symbol,
                            name: p.name,
                            quantity: p.totalShares,
                            costBasisGBP: p.totalCostGBP,
                            avgPriceGBP: p.totalShares > 0 ? p.totalCostGBP / p.totalShares : 0,
                            valueGBP: 0, // Will be updated with current prices
                            type: 'stock',
                            source: 'ibkr',
                            currency: p.currency
                        }));

                    // Add cash balance if positive
                    if (cashBalance > 0) {
                        holdings.push({
                            symbol: 'GBP',
                            name: 'Cash',
                            quantity: 1,
                            valueGBP: cashBalance,
                            type: 'cash',
                            source: 'ibkr'
                        });
                    }

                    return { holdings, transactions: allTransactions };
                },

                parseIBKRActivityStatementRaw(data) {
                    // Data is an array of arrays (no headers)
                    const holdings = [];
                    const positions = [];
                    const currencyTotals = {};
                    const performanceData = {}; // Store P/L data by symbol
                    const allTransactions = []; // Store all buy/sell transactions
                    const tradeCurrencyTotals = {}; // Currency conversion for trades
                    let lastCurrency = null;
                    let totalRealisedPL = 0; // Track realised P/L from performance summary

                    // Step 1: Parse Open Positions section
                    for (const row of data) {
                        const section = row[0];
                        const rowType = row[1];

                        if (section === 'Open Positions') {
                            if (rowType === 'Data') {
                                if (row.length <= 11) continue;
                                // Position row: [section, type, discriminator, asset, currency, symbol, qty, mult, cost, basis, close, value, ...]
                                const currency = row[4];
                                const symbol = row[5];
                                const quantity = parseFloat(String(row[6] || '').replace(/,/g, '')) || 0;
                                const value = parseFloat(String(row[11] || '').replace(/,/g, '')) || 0;

                                if (symbol && quantity > 0.0001 && value > 0) {
                                    positions.push({ symbol, quantity, value, currency });
                                }
                            } else if (rowType === 'Total') {
                                if (row.length <= 11) continue;
                                // Subtotal row - value is in column 11
                                const currency = row[4];
                                const totalValue = parseFloat(String(row[11] || '').replace(/,/g, '')) || 0;

                                if (currency && totalValue > 0) {
                                    if (currency === 'GBP') {
                                        // This is a GBP-converted total - assign to the last non-GBP currency
                                        if (lastCurrency && lastCurrency !== 'GBP' && currencyTotals[lastCurrency]) {
                                            // Only assign if we haven't already assigned a GBP conversion
                                            if (!currencyTotals[lastCurrency].gbp) {
                                                currencyTotals[lastCurrency].gbp = totalValue;
                                                lastCurrency = null; // Reset to avoid overwriting
                                            }
                                        }
                                    } else {
                                        // This is a native currency total
                                        if (!currencyTotals[currency]) {
                                            currencyTotals[currency] = {};
                                        }
                                        currencyTotals[currency].native = totalValue;
                                        lastCurrency = currency;
                                    }
                                }
                            }
                        }
                    }

                    // Step 1.5: Parse Realized & Unrealized Performance Summary for P/L
                    // Column structure: Section, Type, AssetClass, Symbol, ..., RealisedTotal (col 10), UnrealisedTotal (col 14)
                    for (const row of data) {
                        const section = row[0];
                        const rowType = row[1];
                        const assetClass = row[2];

                        if (section === 'Realized & Unrealized Performance Summary' &&
                            rowType === 'Data' &&
                            assetClass === 'Stocks') {
                            if (row.length <= 14) continue;
                            const symbol = row[3];
                            // Realised P/L is typically in column 10 (Realized Total)
                            const realisedTotal = parseFloat(String(row[10] || '').replace(/,/g, '')) || 0;
                            const unrealizedTotal = parseFloat(String(row[14] || '').replace(/,/g, '')) || 0;

                            if (symbol) {
                                performanceData[symbol] = unrealizedTotal;
                                totalRealisedPL += realisedTotal;
                            }
                        }
                    }
                    console.log('IBKR Realised P/L:', totalRealisedPL.toFixed(2));

                    // Step 1.6: Parse Trades section for buy/sell transactions
                    let lastTradeCurrency = null;
                    for (const row of data) {
                        const section = row[0];
                        const rowType = row[1];

                        if (section === 'Trades') {
                            if (rowType === 'Data') {
                                const discriminator = row[2];
                                if (discriminator === 'Order') {
                                    // Trade row: [Trades, Data, Order, AssetClass, Currency, Symbol, DateTime, Quantity, T.Price, C.Price, Proceeds, Comm/Fee, Basis, ...]
                                    const currency = row[4];
                                    const symbol = row[5];
                                    const dateTime = row[6];
                                    const quantity = parseFloat(String(row[7] || '').replace(/,/g, '')) || 0;
                                    const proceeds = parseFloat(String(row[10] || '').replace(/,/g, '')) || 0;
                                    const commission = parseFloat(String(row[11] || '').replace(/,/g, '')) || 0;
                                    const basis = parseFloat(String(row[12] || '').replace(/,/g, '')) || 0;

                                    if (symbol && quantity !== 0) {
                                        if (quantity > 0) {
                                            // Buy transaction
                                            allTransactions.push({
                                                type: 'buy',
                                                symbol: symbol,
                                                shares: quantity,
                                                costNative: basis, // basis includes cost
                                                currency: currency,
                                                date: dateTime,
                                                source: 'ibkr'
                                            });
                                        } else {
                                            // Sell transaction (quantity is negative)
                                            allTransactions.push({
                                                type: 'sell',
                                                symbol: symbol,
                                                shares: Math.abs(quantity),
                                                proceedsNative: Math.abs(proceeds),
                                                currency: currency,
                                                date: dateTime,
                                                source: 'ibkr'
                                            });
                                        }
                                    }
                                }
                            } else if (rowType === 'Total') {
                                // Currency totals for trades: [Trades, Total, , Stocks, Currency, ...]
                                // or GBP conversion: [Trades, Total, , Stocks, GBP, ...]
                                const currency = row[4];
                                const basisTotal = parseFloat(String(row[12] || '').replace(/,/g, '')) || 0;

                                if (currency && basisTotal !== 0) {
                                    if (currency === 'GBP' && lastTradeCurrency && lastTradeCurrency !== 'GBP') {
                                        // This is the GBP conversion total
                                        if (tradeCurrencyTotals[lastTradeCurrency]) {
                                            tradeCurrencyTotals[lastTradeCurrency].gbp = Math.abs(basisTotal);
                                        }
                                    } else if (currency !== 'GBP') {
                                        tradeCurrencyTotals[currency] = { native: Math.abs(basisTotal) };
                                        lastTradeCurrency = currency;
                                    }
                                }
                            }
                        }
                    }

                    // Convert trade costs to GBP
                    for (const tx of allTransactions) {
                        if (tx.currency === 'GBP') {
                            tx.costGBP = tx.costNative || 0;
                            tx.proceedsGBP = tx.proceedsNative || 0;
                        } else if (tradeCurrencyTotals[tx.currency]?.native > 0 && tradeCurrencyTotals[tx.currency]?.gbp > 0) {
                            const conversionFactor = tradeCurrencyTotals[tx.currency].gbp / tradeCurrencyTotals[tx.currency].native;
                            tx.costGBP = (tx.costNative || 0) * conversionFactor;
                            tx.proceedsGBP = (tx.proceedsNative || 0) * conversionFactor;
                        } else {
                            // Fallback: use default rates (may be stale)
                            console.warn('Using fallback exchange rate for', tx.currency, '- rates may be stale');
                            this.exchangeRateError = 'Using fallback exchange rates - prices may be inaccurate';
                            const fallbackRate = tx.currency === 'USD' ? 1.27 :
                                                 tx.currency === 'EUR' ? 1.17 :
                                                 tx.currency === 'CAD' ? 1.78 : 1;
                            tx.costGBP = (tx.costNative || 0) / fallbackRate;
                            tx.proceedsGBP = (tx.proceedsNative || 0) / fallbackRate;
                        }
                    }

                    // Step 2: Convert positions to GBP
                    for (const pos of positions) {
                        let valueGBP;

                        if (pos.currency === 'GBP') {
                            valueGBP = pos.value;
                        } else if (currencyTotals[pos.currency]?.native > 0 && currencyTotals[pos.currency]?.gbp > 0) {
                            const conversionFactor = currencyTotals[pos.currency].gbp / currencyTotals[pos.currency].native;
                            valueGBP = pos.value * conversionFactor;
                        } else {
                            // Fallback: use value as-is
                            valueGBP = pos.value;
                        }

                        let type = 'stock';
                        if (pos.symbol.toLowerCase().includes('etf')) {
                            type = 'etf';
                        }

                        // Get P/L data if available (already in GBP from IBKR)
                        const unrealizedPL = performanceData[pos.symbol] || 0;
                        const costBasisGBP = valueGBP - unrealizedPL;
                        const avgPriceGBP = costBasisGBP / pos.quantity;
                        const unrealizedPLPercent = costBasisGBP > 0 ? (unrealizedPL / costBasisGBP) * 100 : 0;

                        holdings.push({
                            symbol: pos.symbol,
                            name: pos.symbol,
                            quantity: pos.quantity,
                            valueGBP: valueGBP,
                            costBasisGBP: costBasisGBP,
                            avgPriceGBP: avgPriceGBP,
                            unrealizedPL: unrealizedPL,
                            unrealizedPLPercent: unrealizedPLPercent,
                            type,
                            source: 'ibkr'
                        });
                    }

                    // Step 3: Parse Cash Report - capture each currency separately
                    const cashBalances = {};
                    for (const row of data) {
                        const section = row[0];
                        const rowType = row[1];
                        const field = row[2];

                        if (section === 'Cash Report' && rowType === 'Data') {
                            if (field && field.includes('Ending Cash')) {
                                const currency = row[3];
                                const amount = parseFloat(String(row[4] || '').replace(/,/g, '')) || 0;

                                // Skip "Base Currency Summary" - we'll sum individual currencies
                                if (currency && currency !== 'Base Currency Summary' && amount > 1) {
                                    cashBalances[currency] = amount;
                                }
                            }
                        }
                    }

                    // Step 3.5: Parse Forex Balances for exchange rates
                    // Header: Asset Category, Currency, Description, Quantity, Cost Price, Cost Basis in GBP, Close Price, Value in GBP, ...
                    // Row:    Forex,         GBP,      USD,         33447.256, 0.742...,   -24832...,          0.74245,     24832.91...
                    const forexRates = {};
                    for (const row of data) {
                        const section = row[0];
                        const rowType = row[1];

                        if (section === 'Forex Balances' && rowType === 'Data') {
                            const assetCategory = row[2]; // "Forex" or "Total"
                            const description = row[4];   // The actual currency (GBP, USD, etc.)
                            const quantity = parseFloat(String(row[5] || '').replace(/,/g, '')) || 0;
                            const closePrice = parseFloat(String(row[8] || '').replace(/,/g, '')) || 0;

                            if (assetCategory === 'Forex' && description && description !== 'GBP' && quantity > 0 && closePrice > 0) {
                                forexRates[description] = closePrice; // e.g., USD -> 0.74245
                            }
                        }
                    }

                    // Add each currency as a separate cash holding
                    let firstCashEntry = true;
                    for (const [currency, amount] of Object.entries(cashBalances)) {
                        let valueGBP = amount;
                        let displayName = `Cash (${currency})`;

                        if (currency !== 'GBP') {
                            // Convert to GBP using forex rate from the file, or fallback
                            const rate = forexRates[currency] ||
                                (currency === 'USD' ? 0.79 :
                                 currency === 'EUR' ? 0.85 :
                                 currency === 'CAD' ? 0.55 : 1);
                            valueGBP = amount * rate;
                            displayName = `Cash (${currency}: ${currency === 'USD' ? '$' : currency === 'EUR' ? 'â‚¬' : ''}${amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})})`;
                        }

                        if (valueGBP > 1) {
                            const cashEntry = {
                                symbol: `CASH_${currency}`,
                                name: displayName,
                                quantity: amount,
                                valueGBP: valueGBP,
                                type: 'cash',
                                currency: currency,
                                source: 'ibkr'
                            };
                            // Attach realised P/L to the first cash entry
                            if (firstCashEntry) {
                                cashEntry.realisedPL = totalRealisedPL;
                                firstCashEntry = false;
                            }
                            holdings.push(cashEntry);
                        }
                    }

                    // If no cash entries, still add metadata for realised P/L
                    if (firstCashEntry && totalRealisedPL !== 0) {
                        holdings.push({
                            symbol: 'GBP',
                            name: 'Cash',
                            quantity: 1,
                            valueGBP: 0,
                            type: 'cash',
                            source: 'ibkr',
                            realisedPL: totalRealisedPL
                        });
                    }

                    return { holdings, transactions: allTransactions };
                },

                parseIBKRActivityStatement(data) {
                    const holdings = [];
                    const headers = Object.keys(data[0]);

                    // Step 1: Parse Open Positions section
                    const positions = [];
                    const currencyTotals = {}; // Track totals by currency

                    for (const row of data) {
                        const section = row[headers[0]];
                        const rowType = row[headers[1]];

                        if (section === 'Open Positions') {
                            if (rowType === 'Data') {
                                // Individual position row
                                const currency = row[headers[4]];
                                const symbol = row[headers[5]];
                                const quantity = parseFloat(row[headers[6]]?.toString().replace(/,/g, '')) || 0;
                                const value = parseFloat(row[headers[11]]?.toString().replace(/,/g, '')) || 0;

                                if (symbol && quantity > 0.0001 && value > 0) {
                                    positions.push({
                                        symbol,
                                        quantity,
                                        value,
                                        currency
                                    });
                                }
                            } else if (rowType === 'Total') {
                                // Currency subtotal row
                                const currency = row[headers[4]];
                                const totalValue = parseFloat(row[headers[11]]?.toString().replace(/,/g, '')) || 0;

                                if (currency && totalValue) {
                                    if (!currencyTotals[currency]) {
                                        currencyTotals[currency] = { native: 0, gbp: 0 };
                                    }

                                    // Check if this is the GBP-converted total (appears after native currency total)
                                    if (currency === 'GBP' && !currencyTotals.GBP) {
                                        currencyTotals.GBP = { native: totalValue, gbp: totalValue };
                                    } else if (currency === 'GBP') {
                                        // This is a conversion total for another currency
                                        // We need to match it to the previous currency
                                        // For now, skip - we'll use a different approach
                                    } else {
                                        currencyTotals[currency].native = totalValue;
                                    }
                                }
                            }
                        }
                    }

                    // Step 2: Calculate currency conversion factors
                    // Look for "Open Positions,Total,,Stocks,GBP" rows that follow each currency total
                    // These represent the GBP-converted values
                    let lastCurrency = null;
                    for (const row of data) {
                        const section = row[headers[0]];
                        const rowType = row[headers[1]];

                        if (section === 'Open Positions' && rowType === 'Total') {
                            const currency = row[headers[4]];
                            const totalValue = parseFloat(row[headers[9]]?.toString().replace(/,/g, '')) || 0;

                            if (currency === 'GBP' && lastCurrency && lastCurrency !== 'GBP' && totalValue > 0) {
                                // This is the GBP conversion of the last currency
                                if (currencyTotals[lastCurrency]) {
                                    currencyTotals[lastCurrency].gbp = totalValue;
                                }
                            }

                            if (currency !== 'GBP') {
                                lastCurrency = currency;
                            }
                        }
                    }

                    // Step 3: Convert positions to holdings with GBP values
                    for (const pos of positions) {
                        let valueGBP;

                        if (pos.currency === 'GBP') {
                            valueGBP = pos.value;
                        } else if (currencyTotals[pos.currency]?.native > 0 && currencyTotals[pos.currency]?.gbp > 0) {
                            // Use conversion factor from totals
                            const conversionFactor = currencyTotals[pos.currency].gbp / currencyTotals[pos.currency].native;
                            valueGBP = pos.value * conversionFactor;
                        } else {
                            // Fallback: assume 1:1 (not ideal, but better than nothing)
                            valueGBP = pos.value;
                        }

                        // Determine type
                        let type = 'stock';
                        if (pos.symbol.toLowerCase().includes('etf')) {
                            type = 'etf';
                        }

                        holdings.push({
                            symbol: pos.symbol,
                            name: pos.symbol,
                            quantity: pos.quantity,
                            valueGBP: valueGBP,
                            type,
                            source: 'ibkr'
                        });
                    }

                    // Step 4: Parse Cash Report for cash balance
                    let cashBalance = 0;
                    for (const row of data) {
                        const section = row[headers[0]];
                        const rowType = row[headers[1]];
                        const field = row[headers[2]];

                        if (section === 'Cash Report' && rowType === 'Data') {
                            if (field && field.includes('Ending Cash')) {
                                const currency = row[headers[3]];
                                const amount = parseFloat(row[headers[4]]?.toString().replace(/,/g, '')) || 0;

                                if (currency === 'Base Currency Summary' || currency === 'GBP') {
                                    cashBalance = amount;
                                }
                            }
                        }
                    }

                    // Add cash if positive
                    if (cashBalance > 1) {
                        holdings.push({
                            symbol: 'GBP',
                            name: 'Cash',
                            quantity: 1,
                            valueGBP: cashBalance,
                            type: 'cash',
                            source: 'ibkr'
                        });
                    }

                    return { holdings, transactions: [] };
                },

                // Helper to find column with fuzzy matching
                findColumn(headers, possibilities) {
                    for (const header of headers) {
                        const headerLower = header.toLowerCase();
                        for (const possibility of possibilities) {
                            if (headerLower.includes(possibility.toLowerCase())) {
                                return header;
                            }
                        }
                    }
                    return null;
                },

                // Calculate cost basis from all transactions (both T212 and IBKR)
                // Uses average cost method: tracks total shares bought and total cost
                // When selling, reduces cost proportionally
                calculateCostBasisFromTransactions(symbol) {
                    const allTransactions = [
                        ...(this.t212Transactions || []),
                        ...(this.ibkrTransactions || [])
                    ].filter(tx => tx.symbol === symbol);

                    if (allTransactions.length === 0) {
                        return null; // No transactions for this symbol
                    }

                    // Sort by date
                    allTransactions.sort((a, b) => {
                        const dateA = a.date ? new Date(a.date) : new Date(0);
                        const dateB = b.date ? new Date(b.date) : new Date(0);
                        return dateA - dateB;
                    });

                    let totalShares = 0;
                    let totalMoneyIn = 0;  // Total spent on buys
                    let totalMoneyOut = 0; // Total received from sells

                    for (const tx of allTransactions) {
                        if (tx.type === 'buy') {
                            totalShares += tx.shares;
                            totalMoneyIn += tx.costGBP || 0;
                        } else if (tx.type === 'sell') {
                            totalShares -= tx.shares;
                            // Use actual proceeds from sale (not average cost)
                            // This properly accounts for realized gains/losses
                            totalMoneyOut += tx.proceedsGBP || 0;
                        }
                    }

                    // Net investment = money in - money out
                    // This includes any realized losses in the cost basis
                    let netInvestment = totalMoneyIn - totalMoneyOut;

                    // Ensure we don't have negative values due to rounding
                    if (totalShares < 0.0001) totalShares = 0;
                    if (netInvestment < 0) netInvestment = 0;

                    return {
                        costBasisGBP: netInvestment,
                        totalShares: totalShares,
                        avgCostPerShare: totalShares > 0 ? netInvestment / totalShares : 0,
                        transactionCount: allTransactions.length
                    };
                },

                // Manual cash management
                addManualCash() {
                    this.manualCashEntries.push({ label: '', valueGBP: 0 });
                },

                removeManualCash(index) {
                    this.manualCashEntries.splice(index, 1);
                },

                getManualCashHoldings() {
                    return this.manualCashEntries
                        .filter(entry => entry.label && entry.valueGBP > 0)
                        .map(entry => ({
                            symbol: 'CASH',
                            name: entry.label,
                            quantity: 1,
                            valueGBP: entry.valueGBP,
                            type: 'cash',
                            source: 'manual'
                        }));
                },

                addManualHolding() {
                    this.manualHoldings.push({
                        symbol: '',
                        name: '',
                        currentValue: 0,
                        currentValueCurrency: 'USD',
                        costBasis: 0,
                        costBasisCurrency: 'GBP'
                    });
                },

                removeManualHolding(index) {
                    this.manualHoldings.splice(index, 1);
                },

                getManualStockHoldings() {
                    return this.manualHoldings
                        .filter(entry => {
                            // Allow entries with just a symbol (for target % planning even without allocation)
                            return entry.symbol && entry.symbol.trim() !== '';
                        })
                        .map(entry => {
                            // Handle backward compatibility with old valueGBP field
                            let valueGBP = 0;
                            if (entry.valueGBP !== undefined && entry.valueGBP > 0) {
                                // Old format - use directly
                                valueGBP = entry.valueGBP;
                            } else if (entry.currentValue > 0) {
                                // New format - convert based on currency
                                valueGBP = entry.currentValue;
                                if (entry.currentValueCurrency === 'USD') {
                                    valueGBP = valueGBP / this.gbpUsdRate;
                                }
                            }

                            // Handle backward compatibility with old costBasisGBP field
                            let costBasisGBP = 0;
                            if (entry.costBasisGBP !== undefined) {
                                // Old format - migrate to new format
                                costBasisGBP = entry.costBasisGBP;
                            } else if (entry.costBasis) {
                                // New format - convert based on currency
                                costBasisGBP = entry.costBasis;
                                if (entry.costBasisCurrency === 'USD' && costBasisGBP > 0) {
                                    costBasisGBP = costBasisGBP / this.gbpUsdRate;
                                }
                            }

                            const unrealizedPL = costBasisGBP > 0 ? valueGBP - costBasisGBP : undefined;
                            const unrealizedPLPercent = costBasisGBP > 0 ? (unrealizedPL / costBasisGBP) * 100 : undefined;

                            return {
                                symbol: entry.symbol,
                                name: entry.name || entry.symbol,
                                quantity: 1,
                                valueGBP: valueGBP,
                                costBasisGBP: costBasisGBP > 0 ? costBasisGBP : undefined,
                                avgPriceGBP: costBasisGBP > 0 ? costBasisGBP : undefined,
                                unrealizedPL: unrealizedPL,
                                unrealizedPLPercent: unrealizedPLPercent,
                                type: 'stock',
                                source: 'manual'
                            };
                        });
                },

                // Group holdings by symbol
                groupHoldings(holdings) {
                    const groups = {};

                    for (const holding of holdings) {
                        const key = holding.symbol + '|' + holding.type;

                        if (!groups[key]) {
                            groups[key] = { ...holding, sources: [holding.source] };
                        } else {
                            groups[key].valueGBP += holding.valueGBP;
                            groups[key].quantity += holding.quantity;

                            // Aggregate cost basis and P/L
                            if (holding.costBasisGBP !== undefined) {
                                groups[key].costBasisGBP = (groups[key].costBasisGBP || 0) + holding.costBasisGBP;
                                groups[key].unrealizedPL = (groups[key].unrealizedPL || 0) + holding.unrealizedPL;
                            }

                            if (!groups[key].sources.includes(holding.source)) {
                                groups[key].sources.push(holding.source);
                            }
                        }
                    }

                    // Convert to array and set source labels
                    return Object.values(groups).map(group => {
                        const sources = group.sources.filter(s => s !== 'manual');
                        let sourceLabel;

                        if (sources.length > 1) {
                            sourceLabel = sources.join(' + ');
                        } else if (sources.length === 1) {
                            sourceLabel = sources[0];
                        } else {
                            sourceLabel = 'manual';
                        }

                        delete group.sources;
                        group.source = sourceLabel;

                        // Recalculate average price and P/L % for grouped holdings
                        if (group.costBasisGBP !== undefined && group.quantity > 0) {
                            group.avgPriceGBP = group.costBasisGBP / group.quantity;
                            group.unrealizedPLPercent = group.costBasisGBP > 0
                                ? (group.unrealizedPL / group.costBasisGBP) * 100
                                : 0;
                        }

                        return group;
                    });
                },

                // Sorting
                sortBy(field) {
                    if (this.sortField === field) {
                        this.sortAsc = !this.sortAsc;
                    } else {
                        this.sortField = field;
                        this.sortAsc = field === 'symbol'; // Ascending for symbol, descending for numbers
                    }
                },

                removeHolding(holding) {
                    if (confirm(`Are you sure you want to remove ${holding.symbol} from ${holding.source}?`)) {
                        // Remove from the appropriate source array based on holding.source
                        if (holding.source === 't212') {
                            this.t212Holdings = this.t212Holdings.filter(h => h.symbol !== holding.symbol);
                        } else if (holding.source === 'ibkr') {
                            this.ibkrHoldings = this.ibkrHoldings.filter(h => h.symbol !== holding.symbol);
                        } else if (holding.source === 'manual') {
                            // Remove from manual holdings
                            this.manualHoldings = this.manualHoldings.filter(h => h.symbol !== holding.symbol);
                        }
                    }
                },

                // Formatting
                formatNumber(num) {
                    return num.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                },

                // Asset allocation pie chart
                getAssetAllocationGradient() {
                    const DEGREES_PER_PERCENT = 360 / 100;
                    const cash = this.portfolio.cashPercentage;
                    const vusa = this.portfolio.vusaPercentage;
                    const other = this.portfolio.otherStocksPercentage;

                    let currentAngle = 0;
                    const stops = [];

                    // Cash (green)
                    if (cash > 0) {
                        const angle = cash * DEGREES_PER_PERCENT;
                        stops.push(`#10b981 ${currentAngle}deg ${currentAngle + angle}deg`);
                        currentAngle += angle;
                    }

                    // VUSA (purple)
                    if (vusa > 0) {
                        const angle = vusa * DEGREES_PER_PERCENT;
                        stops.push(`#8b5cf6 ${currentAngle}deg ${currentAngle + angle}deg`);
                        currentAngle += angle;
                    }

                    // Other stocks (blue)
                    if (other > 0) {
                        const angle = other * DEGREES_PER_PERCENT;
                        stops.push(`#3b82f6 ${currentAngle}deg ${currentAngle + angle}deg`);
                        currentAngle += angle;
                    }

                    return `conic-gradient(${stops.join(', ')})`;
                },

                // Save to Firebase (single source of truth)
                saveToStorage() {
                    // Sync to Firebase (debounced)
                    if (this.debouncedSyncToCloud) {
                        this.debouncedSyncToCloud();
                    }
                },

                clearAllData() {
                    if (confirm('Are you sure you want to clear imported holdings data? Your manual cash balances and target percentages will be preserved.')) {
                        // Save values we want to keep
                        const keepManualCash = [...this.manualCashEntries];
                        const keepTargetValue = this.targetValue;
                        const keepTargetPercentages = {...this.targetPercentages};
                        const keepTargetCashPercentage = this.targetCashPercentage;
                        const keepTargetReferencePercentage = this.targetReferencePercentage;
                        const keepVisibleColumns = {...this.visibleColumns};
                        const keepGbpUsdRate = this.gbpUsdRate;
                        const keepLastExchangeRateUpdate = this.lastExchangeRateUpdate;

                        // Clear imported holdings data
                        this.t212File = null;
                        this.t212Holdings = [];
                        this.t212RowCount = 0;
                        this.t212Error = null;
                        if (this.$refs.t212Input) this.$refs.t212Input.value = '';

                        this.ibkrFile = null;
                        this.ibkrHoldings = [];
                        this.ibkrRowCount = 0;
                        this.ibkrError = null;
                        if (this.$refs.ibkrInput) this.$refs.ibkrInput.value = '';

                        // Clear manual stock holdings
                        this.manualHoldings = [];

                        // Restore the values we want to keep
                        this.manualCashEntries = keepManualCash;
                        this.targetValue = keepTargetValue;
                        this.targetPercentages = keepTargetPercentages;
                        this.targetCashPercentage = keepTargetCashPercentage;
                        this.targetReferencePercentage = keepTargetReferencePercentage;
                        this.visibleColumns = keepVisibleColumns;
                        this.gbpUsdRate = keepGbpUsdRate;
                        this.lastExchangeRateUpdate = keepLastExchangeRateUpdate;

                        // Save to storage (this will preserve what we want to keep)
                        this.saveToStorage();
                    }
                }
            },
            mounted() {
                // Add one empty manual cash entry by default if no saved data
                if (this.manualCashEntries.length === 0) {
                    this.addManualCash();
                }

                // Close column selector when clicking outside
                document.addEventListener('click', (e) => {
                    const columnSelectorButton = e.target.closest('.relative');
                    if (this.showColumnSelector && !columnSelectorButton) {
                        this.showColumnSelector = false;
                    }
                });

                // Initialize Firebase
                this.initFirebase();

                // Fetch exchange rate
                this.fetchExchangeRate();

                // PWA install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showInstallPrompt = true;
                });
            }
        }).mount('#app');
    </script>
</body>
</html>
